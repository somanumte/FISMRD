{% extends "base.html" %}

{% block title %}An√°lisis de Gastos - Reportes{% endblock %}

{% block extra_css %}
<style>
    .report-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .report-header {
        background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        height: 500px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .table-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        height: 500px;
        overflow-y: auto;
    }

    .expense-table {
        width: 100%;
        border-collapse: collapse;
    }

    .expense-table th,
    .expense-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #f3f4f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h1>üìâ An√°lisis de Gastos</h1>
        <p>Distribuci√≥n de gastos por categor√≠a</p>
    </div>

    <div class="content-grid">
        <div class="card">
            <h3 style="width: 100%; text-align: left; margin-bottom: 1rem;">Distribuci√≥n</h3>
            <div style="position: relative; height: 90%; width: 100%;">
                <canvas id="expensesChart"></canvas>
            </div>
        </div>

        <div class="table-card">
            <h3>Desglose</h3>
            <table class="expense-table" id="expensesTable">
                <thead>
                    <tr>
                        <th>Categor√≠a</th>
                        <th>Total</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetch(`{{ url_for('reports.api_financial_expenses') }}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const d = data.data;
                    const total = d.total;

                    // Chart
                    new Chart(document.getElementById('expensesChart'), {
                        type: 'doughnut',
                        data: {
                            labels: d.labels,
                            datasets: [{
                                data: d.values,
                                backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6', '#6366f1'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' }
                            },
                            cutout: '70%'
                        }
                    });

                    // Table
                    const tbody = document.querySelector('#expensesTable tbody');
                    d.labels.forEach((label, i) => {
                        const val = d.values[i];
                        const percent = ((val / total) * 100).toFixed(1);
                        tbody.innerHTML += `<tr>
                            <td>${label}</td>
                            <td>$${val.toLocaleString()}</td>
                            <td>${percent}%</td>
                        </tr>`;
                    });
                }
            });
    });
</script>
{% endblock %}