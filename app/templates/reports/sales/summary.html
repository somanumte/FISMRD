{% extends "base.html" %}

{% block title %}Resumen de Ventas - Reportes{% endblock %}

{% block extra_css %}
<style>
    .report-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .report-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
    }

    .report-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .breadcrumb {
        display: flex;
        gap: 0.5rem;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .breadcrumb a {
        color: white;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .filters-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .filter-group label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .filter-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .filter-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--metric-color);
    }

    .metric-card.blue {
        --metric-color: #3b82f6;
    }

    .metric-card.green {
        --metric-color: #10b981;
    }

    .metric-card.purple {
        --metric-color: #8b5cf6;
    }

    .metric-card.yellow {
        --metric-color: #f59e0b;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #6b7280;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .metric-change {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
    }

    .metric-change.positive {
        background: #d1fae5;
        color: #065f46;
    }

    .metric-change.negative {
        background: #fee2e2;
        color: #991b1b;
    }

    .chart-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
    }

    .chart-container {
        position: relative;
        height: 400px;
    }

    .export-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-export {
        padding: 0.5rem 1rem;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }

    .btn-export:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        transform: translateY(-2px);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        .report-container {
            padding: 1rem;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- Header -->
    <!-- Hero Section -->
    <div
        class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-indigo-600 via-purple-600 to-purple-800 text-white shadow-xl mb-8">
        <div class="absolute top-0 right-0 -mt-20 -mr-20 w-96 h-96 bg-white/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 -mb-20 -ml-20 w-72 h-72 bg-purple-500/20 rounded-full blur-3xl"></div>

        <div class="relative z-10 px-8 py-12 flex flex-col md:flex-row items-center justify-between gap-8">
            <div class="text-center md:text-left">
                <div class="flex items-center gap-2 mb-4 text-white/80 text-sm font-medium">
                    <a href="{{ url_for('reports.index') }}" class="hover:text-white transition-colors">Reportes</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-white">Resumen de Ventas</span>
                </div>
                <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-4 text-white">
                    Resumen de Ventas
                </h1>
                <p class="text-lg text-purple-100 max-w-2xl leading-relaxed">
                    An√°lisis detallado del rendimiento de ventas por periodo.
                </p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="exportPDF()"
                    class="inline-flex items-center justify-center px-6 py-4 font-bold text-white transition-all duration-200 bg-white/10 border border-white/20 rounded-2xl hover:bg-white/20 hover:scale-105 backdrop-blur-sm">
                    <i class="fas fa-file-pdf mr-2 text-red-400"></i> Exportar PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-card">
        <div class="filters-grid">
            <div class="filter-group">
                <label>Fecha Inicio</label>
                <input type="date" class="filter-input" id="startDate" value="{{ start_date }}">
            </div>
            <div class="filter-group">
                <label>Fecha Fin</label>
                <input type="date" class="filter-input" id="endDate" value="{{ end_date }}">
            </div>
            <div class="filter-group">
                <label>Estado</label>
                <select class="filter-input" id="status">
                    <option value="paid" {% if status=='paid' %}selected{% endif %}>Pagadas</option>
                    <option value="pending" {% if status=='pending' %}selected{% endif %}>Pendientes</option>
                    <option value="cancelled" {% if status=='cancelled' %}selected{% endif %}>Canceladas</option>
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Metodo de Pago</label>
                <select class="filter-input" id="paymentMethod">
                    <option value="">Todos</option>
                    <option value="cash">Efectivo</option>
                    <option value="card">Tarjeta</option>
                    <option value="transfer">Transferencia</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-secondary" onclick="clearFilters()">Limpiar</button>
            <button class="btn btn-primary" onclick="loadReport()">Aplicar Filtros</button>
        </div>
    </div>

    <!-- Metrics -->
    <div class="metrics-grid" id="metricsGrid">
        <div class="metric-card blue">
            <div class="metric-label">Total de Ventas</div>
            <div class="metric-value" id="totalSales">$0.00</div>
            <div class="metric-change positive" id="salesChange">
                <span>+</span> 0%
            </div>
        </div>
        <div class="metric-card green">
            <div class="metric-label">Facturas Emitidas</div>
            <div class="metric-value" id="totalInvoices">0</div>
            <div class="metric-change positive" id="invoicesChange">
                <span>+</span> 0%
            </div>
        </div>
        <div class="metric-card purple">
            <div class="metric-label">Ticket Promedio</div>
            <div class="metric-value" id="avgTicket">$0.00</div>
            <div class="metric-change positive" id="ticketChange">
                <span>+</span> 0%
            </div>
        </div>
        <div class="metric-card yellow">
            <div class="metric-label">Periodo Anterior</div>
            <div class="metric-value" id="prevTotal">$0.00</div>
            <div class="metric-change" id="periodChange">
                <span>-</span> Comparacion
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Tendencia de Ventas</h3>
            <div class="export-buttons">
                <button class="btn-export" onclick="exportPDF()">PDF</button>
                <button class="btn-export" onclick="exportExcel()">Excel</button>
                <button class="btn-export" onclick="exportCSV()">CSV</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let salesChart = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadReport();
    });

    function loadReport() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = document.getElementById('status').value;
        const paymentMethod = document.getElementById('paymentMethod').value;

        showLoading();

        fetch(`{{ url_for('reports.api_sales_summary') }}?start_date=${startDate}&end_date=${endDate}&status=${status}&payment_method=${paymentMethod}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    updateMetrics(result.data);
                    updateChart(result.data.chart_data);
                } else {
                    alert('Error al cargar el reporte: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar el reporte');
            })
            .finally(() => {
                hideLoading();
            });
    }

    function updateMetrics(data) {
        // Total Sales
        document.getElementById('totalSales').textContent = formatCurrency(data.total_sales);

        // Total Invoices
        document.getElementById('totalInvoices').textContent = data.total_invoices;

        // Average Ticket
        document.getElementById('avgTicket').textContent = formatCurrency(data.avg_ticket);

        // Previous Total
        document.getElementById('prevTotal').textContent = formatCurrency(data.prev_total);

        // Growth
        const growth = data.growth;
        const changeElements = document.querySelectorAll('.metric-change');

        changeElements.forEach(el => {
            if (growth > 0) {
                el.classList.remove('negative');
                el.classList.add('positive');
                el.innerHTML = `<span>+</span> ${Math.abs(growth).toFixed(1)}%`;
            } else if (growth < 0) {
                el.classList.remove('positive');
                el.classList.add('negative');
                el.innerHTML = `<span>-</span> ${Math.abs(growth).toFixed(1)}%`;
            } else {
                el.classList.remove('positive', 'negative');
                el.innerHTML = `<span>-</span> 0%`;
            }
        });
    }

    function updateChart(chartData) {
        const ctx = document.getElementById('salesChart').getContext('2d');

        if (salesChart) {
            salesChart.destroy();
        }

        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Ventas ($)',
                        data: chartData.sales,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Facturas (#)',
                        data: chartData.count,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 0) {
                                    label += formatCurrency(context.parsed.y);
                                } else {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Ventas ($)',
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        },
                        ticks: {
                            callback: function (value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Facturas (#)',
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    function formatCurrency(value) {
        return '$' + parseFloat(value).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function clearFilters() {
        const today = new Date().toISOString().split('T')[0];
        const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        document.getElementById('startDate').value = monthAgo;
        document.getElementById('endDate').value = today;
        document.getElementById('status').value = 'paid';
        document.getElementById('paymentMethod').value = '';

        loadReport();
    }

    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    function exportPDF() {
        alert('Exportacion a PDF en desarrollo');
    }

    function exportExcel() {
        alert('Exportacion a Excel en desarrollo');
    }

    function exportCSV() {
        alert('Exportacion a CSV en desarrollo');
    }
</script>
{% endblock %}