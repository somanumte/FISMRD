{% extends "base.html" %}

{% block title %}Dashboard Premium - Luxera AI{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.css" rel="stylesheet">
<style>
    /* Variables CSS modernas */
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --dark: #1f2937;
        --light: #f9fafb;
        --sidebar-width: 250px;
        --header-height: 64px;
    }

    /* Layout principal */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr;
        min-height: 100vh;
    }

    /* Sidebar moderna */
    .dashboard-sidebar {
        background: linear-gradient(180deg, var(--dark) 0%, #111827 100%);
        color: white;
        position: fixed;
        width: var(--sidebar-width);
        height: 100vh;
        overflow-y: auto;
        z-index: 50;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
    }

    .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-nav {
        padding: 1rem 0;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        color: #9ca3af;
        text-decoration: none;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
        border-left-color: var(--primary);
    }

    .nav-item.active {
        background: rgba(99, 102, 241, 0.1);
        color: white;
        border-left-color: var(--primary);
    }

    .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Contenido principal */
    .dashboard-main {
        background: #f9fafb;
        min-height: 100vh;
    }

    .dashboard-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 40;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .period-selector {
        display: flex;
        background: #f3f4f6;
        border-radius: 8px;
        padding: 4px;
    }

    .period-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: #6b7280;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .period-btn:hover {
        background: #e5e7eb;
    }

    .period-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Contenedor principal */
    .dashboard-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Grid de m√©tricas */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .metrics-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    /* Tarjetas de m√©tricas */
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .metric-icon.primary { background: var(--primary); }
    .metric-icon.success { background: var(--success); }
    .metric-icon.warning { background: var(--warning); }
    .metric-icon.danger { background: var(--danger); }

    .metric-trend {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }
    .trend-neutral { color: #6b7280; }

    .metric-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .metric-subtext {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 0.25rem;
    }

    /* Secciones */
    .section {
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title-icon {
        width: 32px;
        height: 32px;
        background: var(--primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    /* Gr√°ficos */
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--dark);
    }

    /* Reporte IA - AHORA COMPACTADO */
    .ai-report-card {
        background: linear-gradient(135deg, var(--dark) 0%, #374151 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .ai-report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .ai-report-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.2) 0%, transparent 70%);
    }

    .ai-report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
        position: relative;
        z-index: 1;
    }

    .ai-report-title {
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .ai-report-content {
        position: relative;
        z-index: 1;
        line-height: 1.6;
        white-space: pre-line;
        margin-top: 1.5rem;
        max-height: 500px;
        overflow-y: auto;
        transition: all 0.3s ease;
        padding-right: 1rem;
    }

    .ai-report-content.collapsed {
        max-height: 0;
        margin-top: 0;
        overflow: hidden;
    }

    /* Botones */
    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-outline {
        background: transparent;
        color: var(--primary);
        border: 1px solid var(--primary);
    }

    .btn-outline:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    /* Tablas */
    .data-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .data-table th {
        background: #f9fafb;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        color: #6b7280;
    }

    .data-table tr:hover {
        background: #f9fafb;
    }

    /* Badges */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
    }

    /* Alertas */
    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        border-left: 4px solid;
    }

    .alert-danger {
        background: #fef2f2;
        border-left-color: var(--danger);
        color: #991b1b;
    }

    .alert-warning {
        background: #fffbeb;
        border-left-color: var(--warning);
        color: #92400e;
    }

    .alert-info {
        background: #eff6ff;
        border-left-color: var(--info);
        color: #1e40af;
    }

    .alert-success {
        background: #f0fdf4;
        border-left-color: var(--success);
        color: #166534;
    }

    /* Grid de gr√°ficos */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 1024px) {
        .charts-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Chatbot */
    .chatbot-toggle {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        z-index: 100;
        transition: all 0.3s;
    }

    .chatbot-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
    }

    .chatbot-window {
        position: fixed;
        bottom: 5rem;
        right: 2rem;
        width: 350px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        z-index: 100;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chatbot-header {
        background: var(--primary);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chatbot-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        background: #f9fafb;
    }

    .chatbot-input {
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        background: white;
    }

    .message {
        margin-bottom: 1rem;
        max-width: 80%;
    }

    .message-user {
        margin-left: auto;
        background: var(--primary);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 12px 12px 0 12px;
    }

    .message-bot {
        margin-right: auto;
        background: white;
        color: #374151;
        padding: 0.75rem 1rem;
        border-radius: 12px 12px 12px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Animaciones */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
        animation: fadeIn 0.3s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }

        .dashboard-main {
            margin-left: 0;
        }

        .dashboard-header {
            padding: 1rem;
        }

        .dashboard-container {
            padding: 1rem;
        }

        .chatbot-window {
            width: calc(100% - 2rem);
            right: 1rem;
            left: 1rem;
        }
    }

    /* Loader */
    .loader {
        border: 3px solid #f3f4f6;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty states */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #9ca3af;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Icono de informaci√≥n */
    .info-icon {
        color: #9ca3af;
        cursor: help;
        font-size: 0.875rem;
        margin-left: 0.25rem;
        transition: color 0.2s;
    }

    .info-icon:hover {
        color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Contenido principal -->
    <main class="dashboard-main">
        <!-- Header -->
        <header class="dashboard-header">
            <div>
                <h1 class="text-xl font-bold text-gray-900">
                    Dashboard Premium
                    <span class="text-sm font-normal text-gray-500 ml-2">{{ period_label }}</span>
                </h1>
            </div>

            <div class="header-actions">
                <!-- Selector de per√≠odo -->
                <div class="period-selector">
                    {% for period_key, period_label in periods.items() %}
                    <button class="period-btn {% if current_period == period_key %}active{% endif %}"
                            onclick="window.location.href='{{ url_for('dashboard.index', period=period_key) }}'">
                        {{ period_label }}
                    </button>
                    {% endfor %}
                </div>

                <!-- Bot√≥n de actualizar -->
                <button onclick="refreshDashboard()" class="btn btn-outline">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>

                <!-- Bot√≥n de reporte -->
                <button onclick="generateReport()" class="btn btn-primary" id="generateReportBtn">
                    <i class="fas fa-file-alt"></i>
                    Reporte
                </button>
            </div>
        </header>

        <!-- Contenedor principal -->
        <div class="dashboard-container">
            <!-- KPIs Financieros -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <div class="section-title-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        Salud Financiera
                    </h2>
                </div>

                <div class="metrics-grid">
                    <!-- Ventas Totales -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon primary">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="metric-trend {{ growth_indicators.revenue.class }}">
                                <i class="fas {{ growth_indicators.revenue.icon }}"></i>
                                <span>{{ growth_indicators.revenue.text }}</span>
                            </div>
                        </div>
                        <div class="metric-value">
                            ${{ "{:,.2f}".format(revenue_current) }}
                        </div>
                        <p class="metric-label">Ventas Totales</p>
                        <p class="metric-subtext">Per√≠odo {{ period_label }}</p>
                    </div>

                    <!-- Utilidad Neta -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon success">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="metric-trend {{ growth_indicators.profit.class }}">
                                <i class="fas {{ growth_indicators.profit.icon }}"></i>
                                <span>{{ growth_indicators.profit.text }}</span>
                            </div>
                        </div>
                        <div class="metric-value">
                            ${{ "{:,.2f}".format(net_profit_current) }}
                        </div>
                        <p class="metric-label">Utilidad Neta</p>
                        <p class="metric-subtext">Margen: {{ net_margin_current|round(1) }}%</p>
                    </div>

                    <!-- Punto de Equilibrio -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon warning">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                        </div>
                        <div class="metric-value">
                            ${{ "{:,.2f}".format(break_even_point) }}
                        </div>
                        <p class="metric-label">Punto de Equilibrio</p>
                        <p class="metric-subtext">Cobertura de gastos operativos</p>
                    </div>

                    <!-- Rotaci√≥n de Inventario -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon info">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                        </div>
                        <div class="metric-value">
                            {{ inventory_turnover|round(1) }}x
                        </div>
                        <p class="metric-label">Rotaci√≥n de Inventario</p>
                        <p class="metric-subtext">{{ avg_inventory_days|round(0) }} d√≠as promedio</p>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos principales -->
            <div class="charts-grid">
                <!-- Tendencia de Ventas -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                Tendencia de Ventas
                                <i class="fas fa-info-circle info-icon" title="Muestra la evoluci√≥n de ventas y ganancias a lo largo del tiempo. Las barras representan ventas y la l√≠nea la ganancia neta."></i>
                            </h3>
                            <div class="flex gap-2 text-sm mt-1">
                                <span class="flex items-center gap-1">
                                    <span class="w-3 h-3 bg-primary rounded-full"></span>
                                    Ventas
                                </span>
                                <span class="flex items-center gap-1">
                                    <span class="w-3 h-3 bg-success rounded-full"></span>
                                    Ganancia
                                </span>
                            </div>
                        </div>
                    </div>
                    <div id="salesChart" style="height: 300px;"></div>
                </div>

                <!-- Rendimiento por Marca -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                Rendimiento por Marca
                                <i class="fas fa-info-circle info-icon" title="Compara el volumen de ventas (barras) y el margen promedio (l√≠nea) por marca. Solo muestra marcas con ventas reales en el per√≠odo."></i>
                            </h3>
                            <span class="text-sm text-gray-500">Ventas vs Margen</span>
                        </div>
                    </div>
                    <div id="brandChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Matriz BCG y Productos -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <div class="section-title-icon">
                            <i class="fas fa-chart-network"></i>
                        </div>
                        Estrategia de Productos
                    </h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Matriz BCG -->
                    <div class="lg:col-span-2">
                        <div class="chart-container">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">
                                        Matriz BCG
                                        <i class="fas fa-info-circle info-icon" title="Clasifica productos por participaci√≥n de mercado (eje X) y tasa de crecimiento (eje Y). El tama√±o del punto indica volumen de ventas."></i>
                                    </h3>
                                    <div class="flex gap-4 text-xs mt-1">
                                        <span class="flex items-center gap-1">
                                            <span class="w-3 h-3 bg-primary rounded-full"></span>
                                            Estrella
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <span class="w-3 h-3 bg-success rounded-full"></span>
                                            Vaca Lechera
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <span class="w-3 h-3 bg-warning rounded-full"></span>
                                            Oportunidad
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <span class="w-3 h-3 bg-gray-500 rounded-full"></span>
                                            Riesgo
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div id="bcgChart" style="height: 400px;"></div>
                        </div>
                    </div>

                    <!-- Top Productos Rentables -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                Top Productos (Profit)
                                <i class="fas fa-info-circle info-icon" title="Productos con mayor ganancia total. Basado en ventas reales y m√°rgenes calculados."></i>
                            </h3>
                            <a href="{{ url_for('inventory.laptops_list') }}" class="text-sm text-primary hover:underline">
                                Ver todos
                            </a>
                        </div>
                        <div class="space-y-4">
                            {% for product in top_profitable[:5] %}
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                <div>
                                    <p class="font-medium text-gray-900">{{ product.name }}</p>
                                    <p class="text-sm text-gray-500">{{ product.category }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-gray-900">${{ "{:,.0f}".format(product.profit) }}</p>
                                    <p class="text-sm {{ 'text-success' if product.margin > 20 else 'text-warning' if product.margin > 10 else 'text-danger' }}">
                                        {{ product.margin|round(1) }}% margen
                                    </p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventario y Alertas -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <div class="section-title-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        Gesti√≥n de Inventario
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Valor en Bodega -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon primary">
                                <i class="fas fa-warehouse"></i>
                            </div>
                        </div>
                        <div class="metric-value">
                            ${{ "{:,.2f}".format(inventory_value) }}
                        </div>
                        <p class="metric-label">Valor en Bodega</p>
                        <p class="metric-subtext">Costo total del inventario</p>
                    </div>

                    <!-- Stock Disponible -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="metric-value">
                            {{ total_available }}
                        </div>
                        <p class="metric-label">Stock Disponible</p>
                        <p class="metric-subtext">Unidades listas para vender</p>
                    </div>

                    <!-- Stock Bajo -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="metric-value">
                            {{ low_stock_count }}
                        </div>
                        <p class="metric-label">Stock Bajo</p>
                        <p class="metric-subtext">Requiere reabastecimiento</p>
                    </div>

                    <!-- Stock Muerto -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-icon danger">
                                <i class="fas fa-skull-crossbones"></i>
                            </div>
                        </div>
                        <div class="metric-value">
                            {{ dead_stock_count }}
                        </div>
                        <p class="metric-label">Stock Muerto</p>
                        <p class="metric-subtext">Sin movimiento en 90 d√≠as</p>
                    </div>
                </div>

                <!-- Alertas -->
                {% if alerts %}
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Alertas Prioritarias</h3>
                    <div class="space-y-3">
                        {% for alert in alerts %}
                        <div class="alert alert-{{ alert.type }}">
                            <i class="fas fa-{{ alert.icon }} mt-1"></i>
                            <div class="flex-1">
                                <h4 class="font-semibold">{{ alert.title }}</h4>
                                <p class="text-sm mt-1">{{ alert.message }}</p>
                                {% if alert.link %}
                                <a href="{{ url_for(alert.link) }}" class="text-sm font-medium mt-2 inline-block">
                                    {{ alert.action }} ‚Üí
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Insights de IA -->
                {% if insights %}
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Insights de IA</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {% for insight in insights %}
                        <div class="bg-white p-4 rounded-lg border {{ 'border-success' if insight.type == 'success' else 'border-warning' if insight.type == 'warning' else 'border-info' }} shadow-sm">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg {{ 'bg-success' if insight.type == 'success' else 'bg-warning' if insight.type == 'warning' else 'bg-info' }} flex items-center justify-center text-white">
                                    <i class="fas fa-{{ insight.icon }}"></i>
                                </div>
                                <h4 class="font-semibold text-gray-900">{{ insight.title }}</h4>
                            </div>
                            <p class="text-gray-700 mb-3">{{ insight.message }}</p>
                            <p class="text-sm text-gray-600 italic">üí° {{ insight.suggestion }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Actividad Reciente -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <div class="section-title-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        Actividad Reciente
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Facturas Recientes -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                Facturas Recientes
                                <i class="fas fa-info-circle info-icon" title="√öltimas facturas generadas con su estado y monto total."></i>
                            </h3>
                            <a href="{{ url_for('invoices.invoices_list') }}" class="text-sm text-primary hover:underline">
                                Ver todas
                            </a>
                        </div>
                        <div class="space-y-3">
                            {% for invoice in recent_invoices %}
                            <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                <div>
                                    <p class="font-medium text-gray-900">{{ invoice.invoice_number }}</p>
                                    <p class="text-sm text-gray-500">{{ invoice.customer_name if invoice.customer_name else 'Cliente' }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-gray-900">${{ "{:,.2f}".format(invoice.total) }}</p>
                                    <span class="badge {{ 'badge-success' if invoice.status == 'paid' else 'badge-warning' if invoice.status == 'issued' else 'badge-info' }}">
                                        {{ invoice.status|title }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Laptops Recientes -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                Laptops Agregadas
                                <i class="fas fa-info-circle info-icon" title="√öltimos productos agregados al inventario con su precio y stock disponible."></i>
                            </h3>
                            <a href="{{ url_for('inventory.laptops_list') }}" class="text-sm text-primary hover:underline">
                                Ver inventario
                            </a>
                        </div>
                        <div class="space-y-3">
                            {% for laptop in recent_laptops %}
                            <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                <div>
                                    <p class="font-medium text-gray-900">{{ laptop.display_name }}</p>
                                    <p class="text-sm text-gray-500">{{ laptop.brand.name if laptop.brand else 'Sin marca' }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-gray-900">${{ "{:,.2f}".format(laptop.sale_price) }}</p>
                                    <p class="text-sm text-gray-500">{{ laptop.quantity }} unidades</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Clientes Recientes -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                Clientes Nuevos
                                <i class="fas fa-info-circle info-icon" title="Clientes registrados recientemente en el sistema."></i>
                            </h3>
                            <a href="{{ url_for('customers.customers_list') }}" class="text-sm text-primary hover:underline">
                                Ver clientes
                            </a>
                        </div>
                        <div class="space-y-3">
                            {% for customer in recent_customers %}
                            <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                <div>
                                    <p class="font-medium text-gray-900">{{ customer.full_name }}</p>
                                    <p class="text-sm text-gray-500">{{ customer.email }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="badge {{ 'badge-success' if customer.is_active else 'badge-danger' }}">
                                        {{ 'Activo' if customer.is_active else 'Inactivo' }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reporte IA - MOVIDO AL FINAL Y COMPACTADO -->
            <div class="ai-report-card animate-in" onclick="toggleAIReport()">
                <div class="ai-report-header">
                    <div>
                        <h2 class="ai-report-title">
                            <i class="fas fa-robot"></i>
                            Reporte Inteligente Luxera AI
                            <span id="aiReportToggle" class="ml-2 text-gray-300 text-sm">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </h2>
                        <p class="text-gray-300 mt-1">An√°lisis ejecutivo generado en tiempo real (click para expandir)</p>
                    </div>
                    <button onclick="event.stopPropagation(); refreshAIReport()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                <div class="ai-report-content collapsed" id="aiReportContent">
                    {{ executive_report|safe }}
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Chatbot -->
<button id="chatbotToggle" class="chatbot-toggle">
    <i class="fas fa-robot"></i>
</button>

<div id="chatbotWindow" class="chatbot-window" style="display: none;">
    <div class="chatbot-header">
        <div class="flex items-center gap-3">
            <i class="fas fa-robot"></i>
            <span class="font-bold">Luxera AI Assistant</span>
        </div>
        <button id="closeChatbot" class="text-white hover:text-gray-300">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chatbot-messages" id="chatMessages">
        <div class="message message-bot">
            ¬°Hola! Soy Luxera AI. Puedo ayudarte a analizar tus ventas, inventario y darte recomendaciones. ¬øEn qu√© puedo ayudarte?
        </div>
    </div>
    <div class="chatbot-input">
        <div class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Escribe tu pregunta..."
                   class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-primary">
            <button id="sendMessage" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
<script>
    // Configuraci√≥n global
    const API_BASE = '/dashboard/api';
    let salesChart, brandChart, bcgChart;
    let aiReportExpanded = false;

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        // Chatbot toggle
        document.getElementById('chatbotToggle').addEventListener('click', function() {
            const chatbot = document.getElementById('chatbotWindow');
            chatbot.style.display = chatbot.style.display === 'none' ? 'flex' : 'none';
        });

        document.getElementById('closeChatbot').addEventListener('click', function() {
            document.getElementById('chatbotWindow').style.display = 'none';
        });

        // Enviar mensaje al chatbot
        document.getElementById('sendMessage').addEventListener('click', sendMessage);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Inicializar gr√°ficos
        initializeCharts();

        // Actualizar hora actual
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);
    });

    // Funciones de utilidad
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });
        const dateString = now.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });

        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = `${timeString} (${dateString})`;
        }
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    function showLoading(button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="loader"></div>';
        button.disabled = true;
        return originalText;
    }

    function hideLoading(button, originalText) {
        button.innerHTML = originalText;
        button.disabled = false;
    }

    function showNotification(message, type = 'success') {
        // Crear notificaci√≥n
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(notification);

        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Funciones del dashboard
    function refreshDashboard() {
        const button = event.target;
        const originalText = showLoading(button);

        fetch(`${API_BASE}/refresh-data?period={{ current_period }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showNotification('Error al actualizar datos', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            })
            .finally(() => {
                hideLoading(button, originalText);
            });
    }

    function generateReport() {
        const button = document.getElementById('generateReportBtn');
        const originalText = showLoading(button);

        fetch(`${API_BASE}/generate-report?period={{ current_period }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('aiReportContent').innerHTML = data.report;
                    showNotification(`Reporte generado para ${data.period}`);
                } else {
                    showNotification('Error al generar reporte', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n', 'error');
            })
            .finally(() => {
                hideLoading(button, originalText);
            });
    }

    function refreshAIReport() {
        const button = event.target;
        const originalText = showLoading(button);

        fetch(`${API_BASE}/generate-report?period={{ current_period }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('aiReportContent').innerHTML = data.report;
                    showNotification('Reporte actualizado');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                hideLoading(button, originalText);
            });
    }

    // Toggle para reporte AI
    function toggleAIReport() {
        const content = document.getElementById('aiReportContent');
        const toggleIcon = document.getElementById('aiReportToggle').querySelector('i');

        if (aiReportExpanded) {
            content.classList.add('collapsed');
            toggleIcon.className = 'fas fa-chevron-down';
        } else {
            content.classList.remove('collapsed');
            toggleIcon.className = 'fas fa-chevron-up';
        }

        aiReportExpanded = !aiReportExpanded;
    }

    // Chatbot
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        // Agregar mensaje del usuario
        addMessage(message, 'user');
        input.value = '';

        // Mostrar typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'message message-bot';
        typingIndicator.innerHTML = `
            <div class="flex gap-1">
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-150"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-300"></span>
            </div>
        `;
        document.getElementById('chatMessages').appendChild(typingIndicator);

        // Enviar a la API
        fetch(`${API_BASE}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            // Remover typing indicator
            typingIndicator.remove();

            if (data.success) {
                addMessage(data.response, 'bot');
            } else {
                addMessage('Lo siento, hubo un error procesando tu mensaje.', 'bot');
            }
        })
        .catch(error => {
            typingIndicator.remove();
            addMessage('Error de conexi√≥n. Intenta de nuevo.', 'bot');
        });
    }

    function addMessage(text, sender) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${sender}`;
        messageDiv.textContent = text;
        messagesDiv.appendChild(messageDiv);

        // Scroll al final
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Gr√°ficos - CONFIGURACI√ìN CORREGIDA PARA EVITAR INTERFERENCIA
    function initializeCharts() {
        // Gr√°fico de ventas - CONFIGURACI√ìN MEJORADA
        const salesData = JSON.parse('{{ daily_sales|safe }}');
        salesChart = new ApexCharts(document.querySelector("#salesChart"), {
            series: [{
                name: 'Ventas',
                type: 'column',
                data: salesData.datasets[0].data
            }, {
                name: 'Ganancia',
                type: 'line',
                data: salesData.datasets[1] ? salesData.datasets[1].data : []
            }],
            chart: {
                height: 300,
                type: 'line',
                toolbar: {
                    show: false,
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: false,
                        reset: true
                    }
                }
            },
            stroke: {
                width: [0, 3],
                curve: 'smooth'
            },
            colors: [salesData.datasets[0].color, salesData.datasets[1]?.color || '#10b981'],
            dataLabels: {
                enabled: false
            },
            markers: {
                size: 0,
                hover: {
                    size: 6
                }
            },
            xaxis: {
                categories: salesData.labels,
                labels: {
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px'
                    }
                }
            },
            yaxis: [{
                title: {
                    text: 'Ventas ($)',
                    style: {
                        color: '#6b7280',
                        fontSize: '12px'
                    }
                },
                labels: {
                    formatter: function(value) {
                        return '$' + (value / 1000).toFixed(0) + 'k';
                    },
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px'
                    }
                }
            }, {
                opposite: true,
                title: {
                    text: 'Ganancia ($)',
                    style: {
                        color: '#6b7280',
                        fontSize: '12px'
                    }
                },
                labels: {
                    formatter: function(value) {
                        return '$' + (value / 1000).toFixed(0) + 'k';
                    },
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px'
                    }
                }
            }],
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function(value) {
                        return '$' + value.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'right',
                fontSize: '12px',
                markers: {
                    width: 12,
                    height: 12,
                    radius: 6
                }
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 4,
                padding: {
                    top: 40,
                    right: 10,
                    bottom: 0,
                    left: 10
                }
            }
        });
        salesChart.render();

        // Gr√°fico de marcas - CONFIGURACI√ìN MEJORADA
        const brandData = {
            brands: {{ brand_performance.brands|tojson }},
            sales: {{ brand_performance.sales|tojson }},
            margins: {{ brand_performance.margins|tojson }}
        };

        brandChart = new ApexCharts(document.querySelector("#brandChart"), {
            series: [{
                name: 'Ventas',
                type: 'bar',
                data: brandData.sales
            }, {
                name: 'Margen %',
                type: 'line',
                data: brandData.margins
            }],
            chart: {
                height: 300,
                type: 'line',
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: false,
                        reset: true
                    }
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '60%',
                    borderRadius: 4
                }
            },
            stroke: {
                width: [0, 3],
                curve: 'smooth'
            },
            colors: ['#6366f1', '#f59e0b'],
            dataLabels: {
                enabled: false
            },
            markers: {
                size: 4,
                hover: {
                    size: 6
                }
            },
            xaxis: {
                categories: brandData.brands,
                labels: {
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px'
                    }
                }
            },
            yaxis: [{
                title: {
                    text: 'Ventas ($)',
                    style: {
                        color: '#6b7280',
                        fontSize: '12px'
                    }
                },
                labels: {
                    formatter: function(value) {
                        return '$' + (value / 1000).toFixed(0) + 'k';
                    },
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px'
                    }
                }
            }, {
                opposite: true,
                title: {
                    text: 'Margen (%)',
                    style: {
                        color: '#6b7280',
                        fontSize: '12px'
                    }
                },
                labels: {
                    formatter: function(value) {
                        return value.toFixed(0) + '%';
                    },
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px'
                    }
                },
                min: 0,
                max: 40
            }],
            tooltip: {
                shared: true,
                intersect: false,
                y: [{
                    formatter: function(value) {
                        return '$' + value.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                }, {
                    formatter: function(value) {
                        return value.toFixed(1) + '%';
                    }
                }]
            },
            legend: {
                position: 'top',
                horizontalAlign: 'right'
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 4,
                padding: {
                    top: 20,
                    right: 10,
                    bottom: 0,
                    left: 10
                }
            }
        });
        brandChart.render();

        // Gr√°fico de matriz BCG - CONFIGURACI√ìN MEJORADA
        const bcgData = JSON.parse('{{ bcg_matrix|safe }}');

        if (bcgData && bcgData.length > 0) {
            bcgChart = new ApexCharts(document.querySelector("#bcgChart"), {
                series: bcgData.map(item => ({
                    name: item.name,
                    data: [[item.x, item.y, item.z]]
                })),
                chart: {
                    height: 400,
                    type: 'bubble',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: false,
                            reset: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                fill: {
                    opacity: 0.8,
                    type: 'solid'
                },
                colors: bcgData.map(item => item.color),
                xaxis: {
                    title: {
                        text: 'Participaci√≥n de Mercado (%)',
                        style: {
                            color: '#6b7280',
                            fontSize: '12px'
                        }
                    },
                    min: 0,
                    max: 100,
                    tickAmount: 5,
                    labels: {
                        formatter: function(value) {
                            return value + '%';
                        },
                        style: {
                            colors: '#6b7280',
                            fontSize: '12px'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Tasa de Crecimiento (%)',
                        style: {
                            color: '#6b7280',
                            fontSize: '12px'
                        }
                    },
                    min: 0,
                    max: 40,
                    tickAmount: 4,
                    labels: {
                        formatter: function(value) {
                            return value + '%';
                        },
                        style: {
                            colors: '#6b7280',
                            fontSize: '12px'
                        }
                    }
                },
                tooltip: {
                    custom: function({ seriesIndex, dataPointIndex, w }) {
                        const item = bcgData[seriesIndex];
                        return `
                            <div class="bg-white p-3 border border-gray-200 shadow-lg rounded-lg">
                                <p class="font-bold text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500 mb-2">${item.label}</p>
                                <div class="text-xs space-y-1">
                                    <p>Participaci√≥n: <span class="font-semibold">${item.x}%</span></p>
                                    <p>Crecimiento: <span class="font-semibold">${item.y}%</span></p>
                                    <p>Ventas: <span class="font-semibold text-green-600">$${formatCurrency(item.z)}</span></p>
                                    <p>Margen: <span class="font-semibold">${item.margin?.toFixed(1) || 'N/A'}%</span></p>
                                </div>
                            </div>
                        `;
                    }
                },
                legend: {
                    show: false
                },
                grid: {
                    borderColor: '#e5e7eb',
                    strokeDashArray: 4,
                    padding: {
                        top: 20,
                        right: 10,
                        bottom: 0,
                        left: 10
                    },
                    xaxis: {
                        lines: {
                            show: true
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                annotations: {
                    xaxis: [{
                        x: 50,
                        strokeDashArray: 4,
                        borderColor: '#9ca3af',
                        label: {
                            borderColor: '#9ca3af',
                            style: {
                                color: '#6b7280',
                                background: '#f9fafb',
                                fontSize: '12px'
                            },
                            text: 'Alta Participaci√≥n'
                        }
                    }],
                    yaxis: [{
                        y: 20,
                        strokeDashArray: 4,
                        borderColor: '#9ca3af',
                        label: {
                            borderColor: '#9ca3af',
                            style: {
                                color: '#6b7280',
                                background: '#f9fafb',
                                fontSize: '12px'
                            },
                            text: 'Alto Crecimiento'
                        }
                    }]
                }
            });
            bcgChart.render();
        }
    }

    // Actualizar gr√°ficos al cambiar per√≠odo
    function updateCharts(period) {
        fetch(`${API_BASE}/sales-trends?period=${period}`)
            .then(response => response.json())
            .then(data => {
                salesChart.updateSeries([{
                    data: data.datasets[0].data
                }, {
                    data: data.datasets[1]?.data || []
                }]);
                salesChart.updateOptions({
                    xaxis: {
                        categories: data.labels
                    }
                });
            });
    }

    // Exportar datos
    function exportData() {
        const data = {
            financial: {{ financial_data|tojson }},
            inventory: {{ inventory_data.summary|tojson }},
            timestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `luxera-dashboard-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showNotification('Datos exportados exitosamente');
    }
</script>
{% endblock %}