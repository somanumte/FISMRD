{% extends 'base.html' %}
{% set hide_search = True %}

{% block title %}Importar desde Icecat{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Animaciones */
    @keyframes pulse-border {
        0%, 100% { border-color: rgba(99, 102, 241, 0.5); }
        50% { border-color: rgba(99, 102, 241, 1); }
    }
    
    .searching {
        animation: pulse-border 1.5s infinite;
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Gallery grid */
    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
    }
    
    .gallery-item {
        aspect-ratio: 1;
        cursor: pointer;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .gallery-item:hover {
        border-color: #6366f1;
        transform: scale(1.05);
    }
    
    .gallery-item.selected {
        border-color: #22c55e;
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
    }
    
    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Spec table */
    .spec-group {
        margin-bottom: 1rem;
    }
    
    .spec-group-header {
        font-weight: 600;
        padding: 0.5rem;
        background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .spec-item {
        display: flex;
        padding: 0.25rem 0.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .dark .spec-item {
        border-bottom-color: rgba(255,255,255,0.05);
    }
    
    .spec-name {
        flex: 0 0 40%;
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .spec-value {
        flex: 1;
        font-weight: 500;
    }
    
    /* Main image preview */
    .main-image-preview {
        max-width: 400px;
        margin: 0 auto;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    
    .main-image-preview img {
        width: 100%;
        height: auto;
    }
    
    /* Tabs */
    .tab-button {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .tab-button.active {
        border-bottom-color: #6366f1;
        color: #6366f1;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }

    /* Select2 Dark Mode */
    .dark .select2-container--default .select2-selection--single {
        background-color: #1f2937;
        border-color: #374151;
        color: #f3f4f6;
    }
    
    .dark .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #f3f4f6;
    }
    
    .dark .select2-dropdown {
        background-color: #1f2937;
        border-color: #374151;
    }
    
    .dark .select2-results__option {
        color: #f3f4f6;
    }
    
    .dark .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #4f46e5;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center space-x-3 mb-4">
                <a href="{{ url_for('inventory.laptops_list') }}"
                    class="text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-cloud-download-alt text-indigo-600 mr-2"></i>
                        Importar desde Icecat
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">
                        Busca productos en el catálogo global de Icecat y completa automáticamente la información
                    </p>
                </div>
            </div>
        </div>

        <!-- Search Panel -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 border border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-search text-indigo-500 mr-2"></i>
                Buscar Producto
            </h2>
            
            <!-- Search Tabs -->
            <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
                <button type="button" class="tab-button active" data-tab="gtin">
                    <i class="fas fa-barcode mr-2"></i> Por Código EAN/UPC
                </button>
                <button type="button" class="tab-button" data-tab="brand">
                    <i class="fas fa-tag mr-2"></i> Por Marca y Part Number
                </button>
                <button type="button" class="tab-button" data-tab="icecat-id">
                    <i class="fas fa-hashtag mr-2"></i> Por ID Icecat
                </button>
            </div>
            
            <!-- Tab Content: GTIN -->
            <div id="tab-gtin" class="tab-content active">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Código EAN/UPC/GTIN
                        </label>
                        <input type="text" id="search-gtin" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                   focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all"
                            placeholder="Ej: 0884116416357" maxlength="14">
                        <p class="mt-1 text-xs text-gray-500">Ingresa el código de barras del producto (8-14 dígitos)</p>
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Idioma
                        </label>
                        <select id="language-gtin" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="ES" selected>Español</option>
                            <option value="EN">English</option>
                            <option value="PT">Português</option>
                            <option value="FR">Français</option>
                            <option value="DE">Deutsch</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="button" id="btn-search-gtin"
                            class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 
                                   text-white font-semibold rounded-xl shadow-lg hover:shadow-xl 
                                   transition-all duration-300 hover:-translate-y-0.5">
                            <i class="fas fa-search mr-2"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Brand + Code -->
            <div id="tab-brand" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Marca
                        </label>
                        <input type="text" id="search-brand" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                   focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20"
                            placeholder="Ej: Dell, HP, Lenovo">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Part Number / Código de Producto
                        </label>
                        <input type="text" id="search-product-code" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                   focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20"
                            placeholder="Ej: XPS-15-9520, 82YU006BUS">
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Idioma
                        </label>
                        <select id="language-brand" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="ES" selected>Español</option>
                            <option value="EN">English</option>
                            <option value="PT">Português</option>
                        </select>
                    </div>
                    <div class="md:col-span-4 flex justify-end">
                        <button type="button" id="btn-search-brand"
                            class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 
                                   text-white font-semibold rounded-xl shadow-lg hover:shadow-xl 
                                   transition-all duration-300 hover:-translate-y-0.5">
                            <i class="fas fa-search mr-2"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Icecat ID -->
            <div id="tab-icecat-id" class="tab-content">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            ID de Icecat
                        </label>
                        <input type="number" id="search-icecat-id" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                   focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20"
                            placeholder="Ej: 85961948">
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Idioma
                        </label>
                        <select id="language-id" 
                            class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                   bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="ES" selected>Español</option>
                            <option value="EN">English</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="button" id="btn-search-id"
                            class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 
                                   text-white font-semibold rounded-xl shadow-lg hover:shadow-xl 
                                   transition-all duration-300 hover:-translate-y-0.5">
                            <i class="fas fa-search mr-2"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div id="search-loading" class="hidden mt-6 text-center">
                <div class="inline-flex items-center px-4 py-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-full">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-indigo-700 dark:text-indigo-300 font-medium">Buscando en Icecat...</span>
                </div>
            </div>
            
            <!-- Error message -->
            <div id="search-error" class="hidden mt-6">
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-circle text-red-500 mt-0.5 mr-3"></i>
                        <div>
                            <h4 class="text-red-800 dark:text-red-200 font-medium">Error en la búsqueda</h4>
                            <p id="error-message" class="text-red-600 dark:text-red-300 text-sm mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel (hidden by default) -->
        <div id="results-panel" class="hidden space-y-6">
            
            <!-- Product Preview Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden fade-in">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        Producto Encontrado
                    </h2>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <!-- Left: Images -->
                        <div>
                            <div id="main-image-container" class="main-image-preview mb-4">
                                <img id="main-product-image" src="" alt="Producto" class="w-full">
                            </div>
                            
                            <div class="mt-4">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center justify-between">
                                    <span><i class="fas fa-images mr-2"></i>Galería de Imágenes</span>
                                    <span class="text-xs font-normal text-gray-500">Click para seleccionar</span>
                                </h4>
                                <div id="gallery-container" class="gallery-grid">
                                    <!-- Se llena dinámicamente -->
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Las imágenes seleccionadas (borde verde) serán importadas
                                </p>
                            </div>
                        </div>
                        
                        <!-- Right: Info -->
                        <div>
                            <div class="mb-4">
                                <span id="product-brand" class="inline-block px-3 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-full text-sm font-medium"></span>
                                <span id="product-category" class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full text-sm ml-2"></span>
                            </div>
                            
                            <h3 id="product-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-2"></h3>
                            <p id="product-name" class="text-gray-600 dark:text-gray-400 mb-4"></p>
                            
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
                                    <span class="text-xs text-gray-500 dark:text-gray-400 block">Icecat ID</span>
                                    <span id="product-icecat-id" class="font-mono font-bold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
                                    <span class="text-xs text-gray-500 dark:text-gray-400 block">Part Number</span>
                                    <span id="product-code" class="font-mono font-bold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
                                    <span class="text-xs text-gray-500 dark:text-gray-400 block">EAN/GTIN</span>
                                    <span id="product-gtin" class="font-mono font-bold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
                                    <span class="text-xs text-gray-500 dark:text-gray-400 block">Garantía</span>
                                    <span id="product-warranty" class="font-bold text-gray-900 dark:text-white"></span>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-align-left mr-2"></i>Descripción
                                </h4>
                                <div id="product-description" class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 max-h-40 overflow-y-auto">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Specifications Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700 fade-in">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-microchip text-indigo-500 mr-2"></i>
                    Especificaciones Técnicas
                </h2>
                
                <div id="specs-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Se llena dinámicamente -->
                </div>
            </div>

            <!-- Import Form Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700 fade-in">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <i class="fas fa-edit text-green-500 mr-2"></i>
                    Configurar e Importar
                </h2>
                
                <form id="import-form" class="space-y-6">
                    <!-- Hidden fields for Icecat data -->
                    <input type="hidden" id="import-icecat-id" name="icecat_id">
                    <input type="hidden" id="import-icecat-gtin" name="icecat_gtin">
                    <input type="hidden" id="import-long-description" name="long_description_html">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Display Name -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Nombre Comercial <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="import-display-name" name="display_name" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20">
                            <p class="mt-1 text-xs text-gray-500">Puedes editar el nombre generado por Icecat</p>
                        </div>
                        
                        <!-- Short Description -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Descripción Corta
                            </label>
                            <textarea id="import-short-description" name="short_description" rows="2" maxlength="300"
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20"></textarea>
                        </div>
                        
                        <!-- Brand -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Marca <span class="text-red-500">*</span>
                            </label>
                            <select id="import-brand-id" name="brand_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog" 
                                data-catalog-type="brand">
                                <option value="">Seleccionar o crear marca</option>
                            </select>
                            <input type="hidden" id="suggested-brand-name">
                        </div>
                        
                        <!-- Model -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Modelo <span class="text-red-500">*</span>
                            </label>
                            <select id="import-model-id" name="model_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="model">
                                <option value="">Seleccionar o crear modelo</option>
                            </select>
                        </div>
                        
                        <!-- Processor -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Procesador <span class="text-red-500">*</span>
                            </label>
                            <select id="import-processor-id" name="processor_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="processor">
                                <option value="">Seleccionar o crear procesador</option>
                            </select>
                        </div>
                        
                        <!-- RAM -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                RAM <span class="text-red-500">*</span>
                            </label>
                            <select id="import-ram-id" name="ram_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="ram">
                                <option value="">Seleccionar o crear RAM</option>
                            </select>
                        </div>
                        
                        <!-- Storage -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Almacenamiento <span class="text-red-500">*</span>
                            </label>
                            <select id="import-storage-id" name="storage_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="storage">
                                <option value="">Seleccionar o crear almacenamiento</option>
                            </select>
                        </div>
                        
                        <!-- Screen -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Pantalla <span class="text-red-500">*</span>
                            </label>
                            <select id="import-screen-id" name="screen_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="screen">
                                <option value="">Seleccionar o crear pantalla</option>
                            </select>
                        </div>
                        
                        <!-- Graphics Card -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Tarjeta Gráfica <span class="text-red-500">*</span>
                            </label>
                            <select id="import-graphics-id" name="graphics_card_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="graphics">
                                <option value="">Seleccionar o crear GPU</option>
                            </select>
                        </div>
                        
                        <!-- OS -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Sistema Operativo <span class="text-red-500">*</span>
                            </label>
                            <select id="import-os-id" name="os_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500 select2-catalog"
                                data-catalog-type="os">
                                <option value="">Seleccionar o crear SO</option>
                            </select>
                        </div>
                        
                        <!-- Store -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Tienda <span class="text-red-500">*</span>
                            </label>
                            <select id="import-store-id" name="store_id" required
                                class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                       focus:border-indigo-500">
                                <option value="">Seleccionar tienda</option>
                                {% for store in stores %}
                                <option value="{{ store.id }}">{{ store.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <hr class="border-gray-200 dark:border-gray-700">
                    
                    <!-- Pricing Section -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <i class="fas fa-dollar-sign text-green-500 mr-2"></i>
                            Precios e Inventario
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Costo de Compra <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-3 text-gray-500">$</span>
                                    <input type="number" id="import-purchase-cost" name="purchase_cost" 
                                        step="0.01" min="0" required
                                        class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                               focus:border-indigo-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Precio de Venta <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-3 text-gray-500">$</span>
                                    <input type="number" id="import-sale-price" name="sale_price" 
                                        step="0.01" min="0" required
                                        class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                               focus:border-indigo-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Cantidad
                                </label>
                                <input type="number" id="import-quantity" name="quantity" 
                                    min="1" value="1"
                                    class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                           bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                           focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Condición
                                </label>
                                <select id="import-condition" name="condition"
                                    class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl 
                                           bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                           focus:border-indigo-500">
                                    <option value="new">Nuevo</option>
                                    <option value="refurbished">Refurbished</option>
                                    <option value="used">Usado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <button type="button" id="btn-import-images"
                            class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl 
                                   hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i>
                            Importar Imágenes Seleccionadas
                        </button>
                        <button type="submit" id="btn-create-laptop"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 
                                   text-white font-bold rounded-xl shadow-lg hover:shadow-xl 
                                   transition-all duration-300 flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i>
                            Crear Laptop en Inventario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== STATE =====
    let currentProduct = null;
    let selectedImages = [];
    let importedImages = [];
    
    // ===== ELEMENTS =====
    const searchLoading = document.getElementById('search-loading');
    const searchError = document.getElementById('search-error');
    const errorMessage = document.getElementById('error-message');
    const resultsPanel = document.getElementById('results-panel');
    
    // ===== TAB SWITCHING =====
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active from all tabs
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activate clicked tab
            button.classList.add('active');
            document.getElementById('tab-' + button.dataset.tab).classList.add('active');
        });
    });
    
    // ===== SEARCH FUNCTIONS =====
    function showLoading() {
        searchLoading.classList.remove('hidden');
        searchError.classList.add('hidden');
        resultsPanel.classList.add('hidden');
    }
    
    function hideLoading() {
        searchLoading.classList.add('hidden');
    }
    
    function showError(message) {
        hideLoading();
        errorMessage.textContent = message;
        searchError.classList.remove('hidden');
    }
    
    function showResults(data) {
        hideLoading();
        searchError.classList.add('hidden');
        resultsPanel.classList.remove('hidden');
        
        currentProduct = data.product;
        const mapped = data.mapped_data;
        
        // Fill product info
        document.getElementById('product-brand').textContent = currentProduct.brand;
        document.getElementById('product-category').textContent = currentProduct.category || 'Sin categoría';
        document.getElementById('product-title').textContent = currentProduct.title;
        document.getElementById('product-name').textContent = currentProduct.product_name;
        document.getElementById('product-icecat-id').textContent = currentProduct.icecat_id;
        document.getElementById('product-code').textContent = currentProduct.product_code || 'N/A';
        document.getElementById('product-gtin').textContent = currentProduct.gtin || 'N/A';
        document.getElementById('product-warranty').textContent = currentProduct.warranty_info || 'N/A';
        document.getElementById('product-description').innerHTML = currentProduct.short_description || currentProduct.summary_short || 'Sin descripción';
        
        // Main image
        if (currentProduct.main_image) {
            document.getElementById('main-product-image').src = currentProduct.main_image.medium_url || currentProduct.main_image.url;
        }
        
        // Gallery
        renderGallery(currentProduct.gallery);
        
        // Specs
        renderSpecs(currentProduct.feature_groups);
        
        // Fill import form
        document.getElementById('import-icecat-id').value = currentProduct.icecat_id;
        document.getElementById('import-icecat-gtin').value = currentProduct.gtin || '';
        document.getElementById('import-display-name').value = currentProduct.title;
        document.getElementById('import-short-description').value = mapped.short_description || currentProduct.summary_short || '';
        document.getElementById('import-long-description').value = currentProduct.long_description || '';
        document.getElementById('suggested-brand-name').value = currentProduct.brand;
        
        // Trigger brand creation/selection
        handleCatalogSuggestion('brand', currentProduct.brand);
        
        // Scroll to results
        resultsPanel.scrollIntoView({ behavior: 'smooth' });
    }
    
    function renderGallery(gallery) {
        const container = document.getElementById('gallery-container');
        container.innerHTML = '';
        selectedImages = [];
        
        if (!gallery || gallery.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm col-span-full">No hay imágenes disponibles</p>';
            return;
        }
        
        gallery.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = 'gallery-item' + (index < 5 ? ' selected' : '');
            div.innerHTML = `<img src="${img.thumb_url || img.low_url || img.url}" alt="Imagen ${index + 1}">`;
            div.dataset.index = index;
            div.dataset.url = img.url;
            div.dataset.thumbUrl = img.thumb_url || img.low_url || img.url;
            
            if (index < 5) {
                selectedImages.push({
                    url: img.url,
                    thumb_url: img.thumb_url,
                    position: index,
                    is_cover: img.is_main || index === 0
                });
            }
            
            div.addEventListener('click', () => toggleImageSelection(div, img, index));
            container.appendChild(div);
        });
    }
    
    function toggleImageSelection(element, img, index) {
        if (element.classList.contains('selected')) {
            element.classList.remove('selected');
            selectedImages = selectedImages.filter(i => i.url !== img.url);
        } else {
            if (selectedImages.length >= 8) {
                alert('Solo puedes seleccionar hasta 8 imágenes');
                return;
            }
            element.classList.add('selected');
            selectedImages.push({
                url: img.url,
                thumb_url: img.thumb_url,
                position: selectedImages.length,
                is_cover: selectedImages.length === 0
            });
        }
        
        // Update main image on click
        document.getElementById('main-product-image').src = img.medium_url || img.url;
    }
    
    function renderSpecs(featureGroups) {
        const container = document.getElementById('specs-container');
        container.innerHTML = '';
        
        if (!featureGroups || Object.keys(featureGroups).length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-full">No hay especificaciones disponibles</p>';
            return;
        }
        
        for (const [groupName, features] of Object.entries(featureGroups)) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'spec-group';
            
            let html = `<div class="spec-group-header text-gray-900 dark:text-white">${groupName}</div>`;
            
            features.slice(0, 8).forEach(feat => {
                html += `
                    <div class="spec-item">
                        <span class="spec-name">${feat.name}</span>
                        <span class="spec-value text-gray-900 dark:text-white">${feat.value}${feat.measure ? ' ' + feat.measure : ''}</span>
                    </div>
                `;
            });
            
            groupDiv.innerHTML = html;
            container.appendChild(groupDiv);
        }
    }
    
    // ===== SEARCH BY GTIN =====
    document.getElementById('btn-search-gtin').addEventListener('click', async () => {
        const gtin = document.getElementById('search-gtin').value.trim();
        const language = document.getElementById('language-gtin').value;
        
        if (!gtin) {
            showError('Por favor ingresa un código GTIN/EAN');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch('/icecat/api/search/gtin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gtin, language })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showResults(data);
            } else {
                showError(data.error || 'Producto no encontrado');
            }
        } catch (error) {
            showError('Error de conexión: ' + error.message);
        }
    });
    
    // ===== SEARCH BY BRAND + CODE =====
    document.getElementById('btn-search-brand').addEventListener('click', async () => {
        const brand = document.getElementById('search-brand').value.trim();
        const productCode = document.getElementById('search-product-code').value.trim();
        const language = document.getElementById('language-brand').value;
        
        if (!brand || !productCode) {
            showError('Por favor ingresa la marca y el código de producto');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch('/icecat/api/search/brand-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brand, product_code: productCode, language })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showResults(data);
            } else {
                showError(data.error || 'Producto no encontrado');
            }
        } catch (error) {
            showError('Error de conexión: ' + error.message);
        }
    });
    
    // ===== SEARCH BY ICECAT ID =====
    document.getElementById('btn-search-id').addEventListener('click', async () => {
        const icecatId = document.getElementById('search-icecat-id').value.trim();
        const language = document.getElementById('language-id').value;
        
        if (!icecatId) {
            showError('Por favor ingresa un ID de Icecat');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch('/icecat/api/search/id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ icecat_id: parseInt(icecatId), language })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showResults(data);
            } else {
                showError(data.error || 'Producto no encontrado');
            }
        } catch (error) {
            showError('Error de conexión: ' + error.message);
        }
    });
    
    // ===== CATALOG HANDLING =====
    async function handleCatalogSuggestion(catalogType, name) {
        if (!name) return;
        
        try {
            const response = await fetch('/icecat/api/catalog/get-or-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ catalog_type: catalogType, name: name })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const selectId = `import-${catalogType}-id`;
                const select = document.getElementById(selectId);
                if (select) {
                    // Add option if doesn't exist
                    let option = select.querySelector(`option[value="${data.id}"]`);
                    if (!option) {
                        option = new Option(data.name, data.id, true, true);
                        select.appendChild(option);
                    }
                    select.value = data.id;
                    
                    // Trigger change for Select2
                    if ($(select).data('select2')) {
                        $(select).trigger('change');
                    }
                }
            }
        } catch (error) {
            console.error('Error handling catalog:', error);
        }
    }
    
    // ===== IMPORT IMAGES =====
    document.getElementById('btn-import-images').addEventListener('click', async () => {
        if (selectedImages.length === 0) {
            alert('Por favor selecciona al menos una imagen');
            return;
        }
        
        const btn = document.getElementById('btn-import-images');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importando...';
        
        try {
            const response = await fetch('/icecat/api/import-images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images: selectedImages })
            });
            
            const data = await response.json();
            
            if (data.success) {
                importedImages = data.imported;
                alert(`${data.message}`);
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Imágenes Importadas';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-green-600');
            } else {
                alert('Error importando imágenes: ' + data.error);
                btn.innerHTML = '<i class="fas fa-download mr-2"></i>Importar Imágenes Seleccionadas';
                btn.disabled = false;
            }
        } catch (error) {
            alert('Error de conexión: ' + error.message);
            btn.innerHTML = '<i class="fas fa-download mr-2"></i>Importar Imágenes Seleccionadas';
            btn.disabled = false;
        }
    });
    
    // ===== CREATE LAPTOP =====
    document.getElementById('import-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validate required fields
        const requiredFields = ['display-name', 'brand-id', 'model-id', 'processor-id', 
                               'ram-id', 'storage-id', 'screen-id', 'graphics-id', 
                               'os-id', 'store-id', 'purchase-cost', 'sale-price'];
        
        for (const field of requiredFields) {
            const element = document.getElementById('import-' + field);
            if (!element || !element.value) {
                alert(`Por favor completa el campo: ${element?.labels?.[0]?.textContent || field}`);
                element?.focus();
                return;
            }
        }
        
        const btn = document.getElementById('btn-create-laptop');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando...';
        
        const formData = {
            icecat_id: document.getElementById('import-icecat-id').value,
            display_name: document.getElementById('import-display-name').value,
            short_description: document.getElementById('import-short-description').value,
            long_description_html: document.getElementById('import-long-description').value,
            brand_id: parseInt(document.getElementById('import-brand-id').value),
            model_id: parseInt(document.getElementById('import-model-id').value),
            processor_id: parseInt(document.getElementById('import-processor-id').value),
            ram_id: parseInt(document.getElementById('import-ram-id').value),
            storage_id: parseInt(document.getElementById('import-storage-id').value),
            screen_id: parseInt(document.getElementById('import-screen-id').value),
            graphics_card_id: parseInt(document.getElementById('import-graphics-id').value),
            os_id: parseInt(document.getElementById('import-os-id').value),
            store_id: parseInt(document.getElementById('import-store-id').value),
            purchase_cost: parseFloat(document.getElementById('import-purchase-cost').value),
            sale_price: parseFloat(document.getElementById('import-sale-price').value),
            quantity: parseInt(document.getElementById('import-quantity').value) || 1,
            condition: document.getElementById('import-condition').value,
            images: importedImages
        };
        
        try {
            const response = await fetch('/icecat/api/create-laptop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`¡Laptop creada exitosamente! SKU: ${data.sku}`);
                window.location.href = data.redirect_url;
            } else {
                alert('Error al crear laptop: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>Crear Laptop en Inventario';
            }
        } catch (error) {
            alert('Error de conexión: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save mr-2"></i>Crear Laptop en Inventario';
        }
    });
    
    // ===== INIT SELECT2 FOR CATALOGS =====
    $('.select2-catalog').each(function() {
        const catalogType = $(this).data('catalog-type');
        $(this).select2({
            tags: true,
            placeholder: 'Buscar o escribir para crear...',
            allowClear: true,
            ajax: {
                url: '/api/catalog/' + catalogType + 's',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return { q: params.term };
                },
                processResults: function(data) {
                    return {
                        results: data.results.map(item => ({
                            id: item.id,
                            text: item.name
                        }))
                    };
                }
            },
            createTag: function(params) {
                const term = $.trim(params.term);
                if (term === '') return null;
                return {
                    id: 'new:' + term,
                    text: term + ' (crear nuevo)',
                    newTag: true
                };
            }
        }).on('select2:select', async function(e) {
            const data = e.params.data;
            if (data.newTag) {
                // Create new catalog item
                const name = data.text.replace(' (crear nuevo)', '');
                const result = await fetch('/icecat/api/catalog/get-or-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ catalog_type: catalogType, name: name })
                });
                const json = await result.json();
                if (json.success) {
                    const newOption = new Option(json.name, json.id, true, true);
                    $(this).append(newOption).trigger('change');
                }
            }
        });
    });
    
    // ===== ENTER KEY TO SEARCH =====
    document.getElementById('search-gtin').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('btn-search-gtin').click();
    });
    
    document.getElementById('search-product-code').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('btn-search-brand').click();
    });
    
    document.getElementById('search-icecat-id').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('btn-search-id').click();
    });
});
</script>
{% endblock %}
