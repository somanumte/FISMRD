{% extends 'base.html' %}
{% set hide_search = True %}

{% block title %}{{ 'Editar' if mode == 'edit' else 'Agregar' }} Laptop{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/laptop_form.css') }}" rel="stylesheet">
<style>
    .scanner-active {
        border-color: #8b5cf6;
        ring: 4px;
        ring-color: rgba(139, 92, 246, 0.2);
    }

    #reader {
        width: 100%;
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .fetching-overlay {
        backdrop-filter: blur(4px);
        background-color: rgba(255, 255, 255, 0.7);
    }

    .dark .fetching-overlay {
        background-color: rgba(17, 24, 39, 0.7);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center space-x-3 mb-4">
                <a href="{{ url_for('inventory.laptops_list') }}"
                    class="text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    {% if mode == 'edit' %}
                    Editar Laptop
                    {% else %}
                    Agregar Nueva Laptop
                    {% endif %}
                </h1>
            </div>
            {% if mode == 'edit' and laptop %}
            <p class="text-gray-600 dark:text-gray-400">
                SKU: <span class="font-mono font-semibold">{{ laptop.sku }}</span>
            </p>
            {% endif %}
        </div>

        <!-- Formulario -->
        <form method="POST" id="laptop-form" class="space-y-6" enctype="multipart/form-data">
            {{ form.hidden_tag() }}

            <!-- Card: Scanner Icecat (NUEVO) -->
            <div class="bg-indigo-600 rounded-xl shadow-lg p-6 text-white overflow-hidden relative">
                <div class="relative z-10">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                        </svg>
                        Escanear Código de Barras (Icecat)
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div class="space-y-4">
                            <p class="text-indigo-100 mb-4">Escanea el código UPC/EAN de la laptop para cargar
                                automáticamente todas las especificaciones e imágenes.</p>

                            <div class="flex space-x-2">
                                <div class="relative flex-1">
                                    {{ form.gtin(class="w-full px-4 py-3 bg-indigo-700 border-2 border-indigo-500
                                    rounded-xl text-white placeholder-indigo-300 focus:outline-none focus:border-white
                                    transition-all", placeholder="O ingresa el código manualmente") }}
                                </div>
                                <button type="button" id="btn-fetch-icecat"
                                    class="bg-white text-indigo-600 px-6 py-3 rounded-xl font-bold hover:bg-indigo-50 transition-colors shadow-md flex items-center">
                                    <span id="fetch-text">Buscar</span>
                                    <svg id="fetch-spinner" class="animate-spin ml-2 h-5 w-5 text-indigo-600 hidden"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </button>
                            </div>

                            <button type="button" id="btn-toggle-scanner"
                                class="w-full py-3 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold flex items-center justify-center transition-all border border-indigo-400">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Iniciar Cámara Scanner
                            </button>
                        </div>

                        <div id="scanner-container" class="hidden">
                            <div id="reader"></div>
                        </div>

                        <div id="scanner-placeholder"
                            class="bg-indigo-700/50 rounded-xl h-48 flex items-center justify-center border-2 border-dashed border-indigo-400 text-indigo-200">
                            Cámara inactiva
                        </div>
                    </div>
                </div>

                <!-- Decoration -->
                <div class="absolute -right-20 -bottom-20 w-64 h-64 bg-indigo-500/30 rounded-full blur-3xl"></div>
                <div class="absolute -left-20 -top-20 w-48 h-48 bg-indigo-400/20 rounded-full blur-3xl"></div>
            </div>

            <!-- Card: Informacion del Producto -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                        </path>
                    </svg>
                    Información del Producto
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nombre Comercial (display_name) - AUTO-GENERADO -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.display_name.label.text }} <span class="text-red-500">*</span>
                            <span class="text-xs font-normal text-indigo-600 dark:text-indigo-400 ml-2">(Generado
                                automáticamente)</span>
                        </label>
                        {{ form.display_name(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="display_name") }}
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                            Se genera automáticamente: Marca + Modelo + Procesador + RAM + Almacenamiento + Pantalla +
                            Categoria
                            <span class="text-indigo-600 dark:text-indigo-400">(Puedes editarlo manualmente)</span>
                        </p>
                        {% if form.display_name.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.display_name.errors[0] }}</p>
                        {% endif %}
                    </div>


                    <!-- URL amigable -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.slug.label.text }}
                        </label>
                        {{ form.slug(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="slug") }}
                    </div>

                    <!-- Descripcion Corta (opcional) -->
                    <!-- Palabras Clave (SEO) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.keywords.label.text }}
                        </label>
                        {{ form.keywords(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="keywords", placeholder="Ej: gaming, ultrabook, intel
                        core i7") }}
                    </div>

                    <!-- Notas Públicas (Descripción para el cliente) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            Notas Públicas (Descripción para el cliente)
                        </label>
                        {{ form.public_notes(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="public_notes", rows="3") }}
                    </div>
                </div>
            </div>

            <!-- Card: Especificaciones Tecnicas -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                    Especificaciones Técnicas
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- Marca -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.brand_id.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.brand_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="brand_id") }}
                        {% if form.brand_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.brand_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- Modelo -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.model_id.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.model_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="model_id") }}
                        {% if form.model_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.model_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- Procesador (Nueva estructura de 3 campos) -->
                    <div
                        class="md:col-span-2 bg-gray-50/50 dark:bg-gray-900/30 p-4 rounded-2xl border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center mb-4">
                            <div
                                class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mr-3">
                                <i class="fas fa-microchip text-indigo-600 dark:text-indigo-400 text-sm"></i>
                            </div>
                            <h3 class="text-sm font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider">
                                Unidad de Procesamiento</h3>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <!-- Familia -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase">
                                    {{ form.processor_family.label.text }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.processor_family(class="w-full px-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20",
                                id="processor_family") }}
                                {% if form.processor_family.errors %}
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400">{{
                                    form.processor_family.errors[0] }}</p>
                                {% endif %}
                            </div>

                            <!-- Generación -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase">
                                    {{ form.processor_generation.label.text }}
                                </label>
                                {{ form.processor_generation(class="w-full px-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20",
                                id="processor_generation") }}
                            </div>

                            <!-- Modelo -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase">
                                    {{ form.processor_model.label.text }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.processor_model(class="w-full px-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20",
                                id="processor_model") }}
                                {% if form.processor_model.errors %}
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.processor_model.errors[0]
                                    }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Nombre Completo / Comercial -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 uppercase">
                                {{ form.processor_full_name.label.text }}
                            </label>
                            {{ form.processor_full_name(class="w-full px-4 py-3 border-2 border-gray-200
                            dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20", id="processor_full_name") }}
                            <p class="mt-1 text-[10px] text-gray-400 italic">Ej: Intel Core i7-12700H (14-Core, up to
                                4.7GHz)</p>
                        </div>
                    </div>

                    <!-- Sistema Operativo -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            Categoría <span class="text-red-500">*</span>
                        </label>
                        {{ form.os_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl
                        bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500 focus:ring-4
                        focus:ring-indigo-500/20", id="os_id") }}
                        {% if form.os_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.os_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- Pantalla -->
                    <div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                    {{ form.screen_id.label.text }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.screen_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                                rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                                focus:border-indigo-500
                                focus:ring-4 focus:ring-indigo-500/20", id="screen_id") }}
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                    Tamaño (")
                                </label>
                                {{ form.screen_size(class="w-full px-4 py-3 border-2 border-gray-200
                                dark:border-gray-700
                                rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                                focus:border-indigo-500
                                focus:ring-4 focus:ring-indigo-500/20", id="screen_size") }}
                            </div>
                        </div>
                        {% if form.screen_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.screen_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- Tarjeta Gráfica -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.graphics_card_id.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.graphics_card_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="graphics_card_id") }}
                        <div class="mt-2 text-sm">
                            <label class="inline-flex items-center">
                                {{ form.has_discrete_gpu(class="h-4 w-4 text-indigo-600 focus:ring-indigo-500
                                border-gray-300 rounded") }}
                                <span class="ml-2 text-gray-700 dark:text-gray-300">GPU Dedicada</span>
                            </label>
                        </div>
                        {% if form.graphics_card_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.graphics_card_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- Almacenamiento -->
                    <div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                    {{ form.storage_id.label.text }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.storage_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                                rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                                focus:border-indigo-500
                                focus:ring-4 focus:ring-indigo-500/20", id="storage_id") }}
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                    Capacidad (GB)
                                </label>
                                {{ form.storage_capacity(class="w-full px-4 py-3 border-2 border-gray-200
                                dark:border-gray-700
                                rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                                focus:border-indigo-500
                                focus:ring-4 focus:ring-indigo-500/20", id="storage_capacity") }}
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                {{ form.storage_upgradeable }}
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Ampliable</span>
                            </label>
                        </div>
                        {% if form.storage_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.storage_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- RAM -->
                    <div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                    {{ form.ram_id.label.text }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.ram_id(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                                rounded-xl
                                bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                                focus:ring-4
                                focus:ring-indigo-500/20", id="ram_id") }}
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                    Capacidad (GB)
                                </label>
                                {{ form.ram_capacity(class="w-full px-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl
                                bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                                focus:ring-4
                                focus:ring-indigo-500/20", id="ram_capacity") }}
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                {{ form.ram_upgradeable }}
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Ampliable</span>
                            </label>
                        </div>
                        {% if form.ram_id.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.ram_id.errors[0] }}</p>
                        {% endif %}
                    </div>

                    <!-- NPU y Retroiluminación -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Inteligencia Artificial (NPU)
                            </label>
                            <label class="inline-flex items-center mt-2">
                                {{ form.npu(class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300
                                rounded") }}
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Tiene NPU (AI Boost)</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                Retroiluminación
                            </label>
                            <label class="inline-flex items-center mt-2">
                                {{ form.keyboard_backlight(class="h-4 w-4 text-indigo-600 focus:ring-indigo-500
                                border-gray-300
                                rounded") }}
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Teclado
                                    retroiluminado</span>
                            </label>
                        </div>
                    </div>

                    <!-- Teclado -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.keyboard_layout.label.text }}
                        </label>
                        {{ form.keyboard_layout(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20") }}
                    </div>

                    <!-- Puertos de Conectividad (NUEVO) -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.connectivity_ports.label.text }}
                        </label>
                        {{ form.connectivity_ports(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20 shadow-sm", id="connectivity_ports", rows="2") }}
                    </div>

                    <!-- WiFi y Celular -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.wifi_standard.label.text }}
                        </label>
                        {{ form.wifi_standard(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="wifi_standard") }}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                            {{ form.cellular.label.text }}
                        </label>
                        {{ form.cellular(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20", id="cellular") }}
                    </div>
                </div>
            </div>

            <!-- Card: Galería de Imágenes HÍBRIDA -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                            <svg class="w-6 h-6 mr-2 text-pink-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            Galería de Imágenes
                        </h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {% if mode == 'edit' %}
                            Gestiona las imágenes de la laptop. Puedes agregar tantas como necesites.
                            {% else %}
                            Sube las imágenes de la laptop. La primera será la portada. Formatos: JPG, PNG, WebP, GIF,
                            AVIF.
                            {% endif %}
                        </p>
                    </div>

                    <div class="info-icon-container-premium">
                        <button type="button" class="info-icon-premium" id="info-icon-premium">
                            <i class="fas fa-info-circle"></i>
                        </button>

                        <div class="tips-tooltip-premium" id="tips-tooltip-premium">
                            <div class="tips-title-premium">
                                <i class="fas fa-lightbulb"></i> Consejos para tu galería
                            </div>
                            <ul class="tips-list-premium">
                                <li class="tip-item-premium">
                                    <i class="fas fa-star"></i>
                                    <span>La primera imagen será la portada principal.</span>
                                </li>
                                <li class="tip-item-premium">
                                    <i class="fas fa-expand-alt"></i>
                                    <span>Usa imágenes de alta calidad (mínimo 800×600px).</span>
                                </li>
                                <li class="tip-item-premium">
                                    <i class="fas fa-search"></i>
                                    <span>El texto alternativo mejora el SEO y accesibilidad.</span>
                                </li>
                                {% if mode == 'edit' %}
                                <li class="tip-item-premium">
                                    <i class="fas fa-cloud"></i>
                                    <span>Badge verde = Ya guardada | Badge azul = Nueva</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Área de Drag & Drop -->
                <div class="upload-area-premium" id="upload-area-premium">
                    <div class="upload-icon-premium">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3 class="upload-title">Arrastra y suelta tus imágenes aquí</h3>
                    <p class="upload-subtitle">o haz clic en el botón para buscar archivos</p>
                    <button type="button" class="browse-btn-premium" id="browse-btn-premium">
                        <i class="fas fa-folder-open"></i> Buscar imágenes
                    </button>

                    <!-- Contenedor del grid (se llena dinámicamente) -->
                    <div class="images-grid-premium" id="images-container-premium">
                        <!-- El JavaScript renderizará aquí las tarjetas -->
                    </div>

                    <!-- Input para carga múltiple (oculto) -->
                    <input type="file" id="bulk-upload-premium"
                        accept="image/jpeg,image/jpg,image/png,image/webp,image/gif,image/avif" multiple class="hidden">
                </div>

                <!-- ===== INPUTS ORIGINALES DEL FORMULARIO ===== -->
                <!-- Estos inputs son manipulados por el componente JavaScript -->
                <div class="hidden" id="original-form-fields">
                    {% set max_pos = 8 %}
                    {% if images_by_position %}
                    {% set positions = images_by_position.keys()|list %}
                    {% if positions %}
                    {% set max_pos = [positions|max, 8]|max %}
                    {% endif %}
                    {% endif %}

                    {% for i in range(1, max_pos + 1) %}
                    <div class="image-slot-original" data-slot="{{ i }}">
                        {% if mode == 'edit' %}
                        {% set img = images_by_position.get(i) %}
                        {% else %}
                        {% set img = None %}
                        {% endif %}

                        <!-- Input file -->
                        <input type="file" id="image_{{ i }}" name="image_{{ i }}" class="hidden original-image-input"
                            accept="image/jpeg,image/jpg,image/png,image/webp,image/gif,image/avif" {% if img %}
                            data-image-id="{{ img.id }}"
                            data-image-url="{{ url_for('static', filename=img.image_path) }}"
                            data-is-cover="{{ 'true' if img.is_cover else 'false' }}" value="{{ img.image_path }}" {%
                            endif %}>

                        <!-- Input alt text -->
                        <input type="text" id="image_{{ i }}_alt" name="image_{{ i }}_alt"
                            class="hidden original-alt-input" {% if img %} value="{{ img.alt_text or '' }}" {% endif %}>

                        <!-- Input path para imágenes existentes -->
                        <input type="hidden" id="image_{{ i }}_path" name="image_{{ i }}_path" {% if img %}
                            value="{{ img.image_path }}" {% endif %}>

                        <!-- Input ID para imágenes existentes -->
                        <input type="hidden" id="image_{{ i }}_id" name="image_{{ i }}_id" {% if img %}
                            value="{{ img.id }}" {% endif %}>

                        <!-- Input URL para imágenes de Icecat -->
                        <input type="hidden" id="image_{{ i }}_url" name="image_{{ i }}_url" value="">

                    </div>
                    {% endfor %}

                    <!-- Input oculto para IDs de imágenes a eliminar -->
                    <input type="hidden" id="images_to_delete" name="images_to_delete" value="[]">

                    <!-- Input oculto para ID de imagen de portada -->
                    <input type="hidden" id="cover_image_id" name="cover_image_id" {% if laptop and
                        laptop.cover_image_id %} value="{{ laptop.cover_image_id }}" {% endif %}>
                </div>
                <!-- Overlay de arrastre -->
                <div id="drag-overlay-premium" class="drag-overlay-premium">
                    <div class="drag-message-premium">
                        <i class="fas fa-cloud-upload-alt text-4xl text-pink-500 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Suelta las imágenes aquí
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400">Tus imágenes se organizarán automáticamente</p>
                    </div>
                </div>

                <!-- Card: Precios y Costos -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Precios y Costos
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                        <!-- Moneda -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.currency.label.text }}
                            </label>
                            {{ form.currency(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500
                            focus:ring-4 focus:ring-indigo-500/20", id="currency") }}
                        </div>

                        <!-- Costo de Compra -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.purchase_cost.label.text }} <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                {{ form.purchase_cost(class="w-full pl-8 pr-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            </div>
                            {% if form.purchase_cost.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.purchase_cost.errors[0] }}
                            </p>
                            {% endif %}
                        </div>

                        <!-- Precio de Venta -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.sale_price.label.text }} <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                {{ form.sale_price(class="w-full pl-8 pr-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            </div>
                            {% if form.sale_price.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.sale_price.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Precio de Descuento -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.discount_price.label.text }}
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                                {{ form.discount_price(class="w-full pl-8 pr-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Opcional - precio promocional</p>
                        </div>

                        <!-- Impuesto -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.tax_percent.label.text }}
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">%</span>
                                {{ form.tax_percent(class="w-full pl-8 pr-4 py-3 border-2 border-gray-200
                                dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900
                                dark:text-gray-100 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Porcentaje de impuesto</p>
                        </div>
                    </div>

                    <!-- Rentabilidades -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Rentabilidad Precio Normal -->
                        <div
                            class="bg-gray-50 dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h3 class="text-md font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Rentabilidad - Precio Normal
                            </h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Margen:</span>
                                    <span id="normal-margin-display" class="text-2xl font-bold margin-good">0%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Ganancia:</span>
                                    <span id="normal-profit-display"
                                        class="text-lg font-semibold text-gray-900 dark:text-white">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Precio final:</span>
                                    <span id="normal-final-price"
                                        class="text-lg font-semibold text-gray-900 dark:text-white">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Rentabilidad Precio Promocional -->
                        <div
                            class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-200 dark:border-yellow-800">
                            <h3 class="text-md font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                                Rentabilidad - Precio Promocional
                            </h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Margen:</span>
                                    <span id="promo-margin-display" class="text-2xl font-bold margin-warning">0%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Ganancia:</span>
                                    <span id="promo-profit-display"
                                        class="text-lg font-semibold text-gray-900 dark:text-white">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Precio final:</span>
                                    <span id="promo-final-price"
                                        class="text-lg font-semibold text-gray-900 dark:text-white">$0.00</span>
                                </div>
                                <div id="promo-section" class="hidden">
                                    <div class="mt-2 pt-2 border-t border-yellow-200 dark:border-yellow-800">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600 dark:text-gray-400">Descuento:</span>
                                            <span id="discount-percentage"
                                                class="text-sm font-semibold text-yellow-600 dark:text-yellow-400">0%</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="no-promo-message" class="text-sm text-gray-500 dark:text-gray-400 italic">
                                    No hay precio promocional establecido
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card: Inventario y Categoria -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Inventario y Categoria
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Cantidad -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.quantity.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.quantity(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            {% if form.quantity.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.quantity.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Alerta Minima -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.min_alert.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.min_alert(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            {% if form.min_alert.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.min_alert.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Categoria -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.category.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.category(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20", id="category") }}
                            {% if form.category.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.category.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Opciones de Publicacion -->
                    <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-md font-semibold text-gray-900 dark:text-white mb-4">Opciones de Publicacion
                        </h3>
                        <div class="flex flex-wrap gap-6">
                            <label class="inline-flex items-center">
                                {{ form.is_published(class="h-5 w-5 text-indigo-600 focus:ring-indigo-500
                                border-gray-300 rounded") }}
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Publicado (visible al
                                    publico)</span>
                            </label>
                            <label class="inline-flex items-center">
                                {{ form.is_featured(class="h-5 w-5 text-yellow-600 focus:ring-yellow-500 border-gray-300
                                rounded") }}
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Destacado</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Card: Números de Serie -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700"
                    id="serials-card">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                            <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h2m10 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                                </path>
                            </svg>
                            Números de Serie
                            <span class="ml-2 text-sm font-normal text-gray-500">(opcional)</span>
                        </h2>
                        <span id="serial-count"
                            class="px-3 py-1 text-sm bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300 rounded-full">
                            0 seriales
                        </span>
                    </div>

                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Registra los números de serie de fabricante para cada unidad. Esto permite rastrear cada laptop
                        individualmente.
                    </p>

                    <!-- Input para agregar seriales -->
                    <div class="flex gap-2 mb-4">
                        <div class="flex-1 relative">
                            <input type="text" id="serial-input" placeholder="Escanea o escribe el número de serie..."
                                class="w-full px-4 py-3 pl-10 border-2 border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/20 font-mono uppercase"
                                autocomplete="off">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h2m10 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                                </path>
                            </svg>
                        </div>
                        <button type="button" onclick="addSerialFromInput()"
                            class="px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Lista de seriales agregados -->
                    <div id="serials-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Los seriales se agregan aquí dinámicamente -->
                    </div>

                    <!-- Input oculto para enviar los seriales -->
                    <input type="hidden" name="serials_json" id="serials-json" value="[]">

                    <!-- Mensaje cuando no hay seriales -->
                    <div id="no-serials-message" class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h2m10 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                            </path>
                        </svg>
                        <p class="text-sm">No hay seriales registrados</p>
                        <p class="text-xs mt-1">Escanea o escribe los números de serie</p>
                    </div>

                    <!-- Información de cantidad -->
                    <div id="serial-quantity-info" class="mt-4 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Cantidad en inventario:</span>
                            <span id="inventory-qty" class="font-semibold text-gray-900 dark:text-white">0</span>
                        </div>
                        <div class="flex items-center justify-between text-sm mt-1">
                            <span class="text-gray-600 dark:text-gray-400">Seriales registrados:</span>
                            <span id="serials-qty" class="font-semibold text-purple-600 dark:text-purple-400">0</span>
                        </div>
                    </div>
                </div>

                <!-- Card: Ubicacion y Estado -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Ubicacion y Estado
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Tienda -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.store_id.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.store_id(class="select2-ajax w-full", id="store_id") }}
                            {% if form.store_id.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.store_id.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Ubicacion -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.location_id.label.text }}
                            </label>
                            {{ form.location_id(class="select2-ajax w-full", id="location_id") }}
                        </div>

                        <!-- Proveedor -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.supplier_id.label.text }}
                            </label>
                            {{ form.supplier_id(class="select2-ajax w-full", id="supplier_id") }}
                        </div>

                        <!-- Condicion -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.condition.label.text }} <span class="text-red-500">*</span>
                            </label>
                            {{ form.condition(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20") }}
                            {% if form.condition.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.condition.errors[0] }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Card: Comercial y Garantía (NUEVO V2.0) -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                            </path>
                        </svg>
                        Comercial y Garantía
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Meses de Garantía -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.warranty_months.label.text }}
                            </label>
                            {{ form.warranty_months(class="w-full px-4 py-3 border-2 border-gray-200
                            dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500
                            focus:ring-4 focus:ring-indigo-500/20", id="warranty_months") }}
                        </div>

                        <!-- Vencimiento de Garantía -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">
                                {{ form.warranty_expiry.label.text }}
                            </label>
                            {{ form.warranty_expiry(class="w-full px-4 py-3 border-2 border-gray-200
                            dark:border-gray-700
                            rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
                            focus:border-indigo-500
                            focus:ring-4 focus:ring-indigo-500/20", type="date", id="warranty_expiry") }}
                        </div>
                    </div>
                </div>

                <!-- Card: Notas -->
                <div>
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z">
                                </path>
                            </svg>
                            Notas Internas
                        </h2>

                        {{ form.internal_notes(class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-700
                        rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:border-indigo-500
                        focus:ring-4 focus:ring-indigo-500/20") }}
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Estas notas son internas y no se
                            muestran al publico</p>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('inventory.laptops_list') }}"
                        class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-semibold">
                        Cancelar
                    </a>

                    <button type="submit" id="submit-btn"
                        class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300">
                        {{ form.submit.label.text or 'Guardar Laptop' }}
                    </button>
                </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery (requerido para Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<!-- Scripts separados para mejor organización -->
<script src="{{ url_for('static', filename='js/laptop_form.js') }}"></script>
<script src="{{ url_for('static', filename='js/laptop_form_submit.js') }}"></script>
<script src="{{ url_for('static', filename='js/laptop_gallery.js') }}"></script>

<!-- Script para calcular rentabilidades -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const purchaseCostInput = document.querySelector('#purchase_cost');
        const salePriceInput = document.querySelector('#sale_price');
        const discountPriceInput = document.querySelector('#discount_price');
        const taxPercentInput = document.querySelector('#tax_percent');

        // Elementos para mostrar rentabilidades
        const normalMarginDisplay = document.getElementById('normal-margin-display');
        const normalProfitDisplay = document.getElementById('normal-profit-display');
        const normalFinalPrice = document.getElementById('normal-final-price');

        const promoMarginDisplay = document.getElementById('promo-margin-display');
        const promoProfitDisplay = document.getElementById('promo-profit-display');
        const promoFinalPrice = document.getElementById('promo-final-price');
        const discountPercentage = document.getElementById('discount-percentage');
        const promoSection = document.getElementById('promo-section');
        const noPromoMessage = document.getElementById('no-promo-message');

        // Función para calcular rentabilidades
        function calculateProfitabilities() {
            const purchaseCost = parseFloat(purchaseCostInput.value) || 0;
            const salePrice = parseFloat(salePriceInput.value) || 0;
            const discountPrice = parseFloat(discountPriceInput.value) || 0;
            const taxPercent = parseFloat(taxPercentInput.value) || 0;

            // Calcular rentabilidad con precio normal
            const normalProfit = salePrice - purchaseCost;
            const normalMargin = purchaseCost > 0 ? (normalProfit / purchaseCost) * 100 : 0;
            const normalPriceWithTax = salePrice * (1 + taxPercent / 100);

            // Actualizar displays precio normal
            normalProfitDisplay.textContent = `$${normalProfit.toFixed(2)}`;
            normalFinalPrice.textContent = `$${normalPriceWithTax.toFixed(2)}`;

            // Determinar color del margen normal
            normalMarginDisplay.textContent = `${normalMargin.toFixed(1)}%`;
            if (normalMargin >= 30) {
                normalMarginDisplay.className = 'text-2xl font-bold margin-good';
            } else if (normalMargin >= 15) {
                normalMarginDisplay.className = 'text-2xl font-bold margin-warning';
            } else {
                normalMarginDisplay.className = 'text-2xl font-bold margin-danger';
            }

            // Calcular rentabilidad con precio promocional
            if (discountPrice > 0 && discountPrice < salePrice) {
                const promoProfit = discountPrice - purchaseCost;
                const promoMargin = purchaseCost > 0 ? (promoProfit / purchaseCost) * 100 : 0;
                const promoPriceWithTax = discountPrice * (1 + taxPercent / 100);
                const discountPercent = ((salePrice - discountPrice) / salePrice) * 100;

                // Actualizar displays precio promocional
                promoProfitDisplay.textContent = `$${promoProfit.toFixed(2)}`;
                promoFinalPrice.textContent = `$${promoPriceWithTax.toFixed(2)}`;
                discountPercentage.textContent = `${discountPercent.toFixed(1)}%`;

                // Determinar color del margen promocional
                promoMarginDisplay.textContent = `${promoMargin.toFixed(1)}%`;
                if (promoMargin >= 30) {
                    promoMarginDisplay.className = 'text-2xl font-bold margin-good';
                } else if (promoMargin >= 15) {
                    promoMarginDisplay.className = 'text-2xl font-bold margin-warning';
                } else {
                    promoMarginDisplay.className = 'text-2xl font-bold margin-danger';
                }

                // Mostrar sección promocional
                promoSection.classList.remove('hidden');
                noPromoMessage.classList.add('hidden');
            } else {
                // No hay precio promocional
                promoMarginDisplay.textContent = '0%';
                promoMarginDisplay.className = 'text-2xl font-bold margin-warning';
                promoProfitDisplay.textContent = '$0.00';
                promoFinalPrice.textContent = '$0.00';

                // Ocultar sección promocional
                promoSection.classList.add('hidden');
                noPromoMessage.classList.remove('hidden');
            }
        }

        // Escuchar cambios en los inputs de precio
        purchaseCostInput.addEventListener('input', calculateProfitabilities);
        salePriceInput.addEventListener('input', calculateProfitabilities);
        discountPriceInput.addEventListener('input', calculateProfitabilities);
        taxPercentInput.addEventListener('input', calculateProfitabilities);

        // Calcular inicialmente
        calculateProfitabilities();
    });
</script>

<!-- Mensajes de error del formulario -->
<script>
    {% with messages = get_flashed_messages(with_categories = true) %}
    {% if messages %}
    $(document).ready(function () {
        {% for category, message in messages %}
        {% if category == 'error' %}
        alert('Error: {{ message }}');
        {% elif category == 'success' %}
        console.log('Éxito: {{ message }}');
        {% endif %}
        {% endfor %}
    });
    {% endif %}
    {% endwith %}

    // Manejar el caso cuando hay errores de validación en campos específicos
    $(document).ready(function () {
        // Si hay errores, mostrar el formulario con los errores
        $('.is-invalid').each(function () {
            $(this).addClass('border-red-500');
        });
    });

    // Sincronización de portada - actualizar campo cover_image_id cuando se cambie la portada
    document.addEventListener('DOMContentLoaded', function () {
        // Función para actualizar el campo de portada
        function updateCoverImageId(imageId) {
            const coverInput = document.getElementById('cover_image_id');
            if (coverInput) {
                coverInput.value = imageId || '';
            }
        }

        // Inicializar con la primera imagen como portada (si existe)
        const firstImageInput = document.getElementById('image_1');
        if (firstImageInput && firstImageInput.dataset.imageId) {
            updateCoverImageId(firstImageInput.dataset.imageId);
        }

        // Escuchar cambios en los inputs de imagen para actualizar la portada
        for (let i = 1; i <= 8; i++) {
            const imageInput = document.getElementById('image_' + i);
            if (imageInput) {
                imageInput.addEventListener('change', function () {
                    // Si esta es la primera imagen (posición 1), se convierte en portada
                    if (i === 1 && this.files && this.files[0]) {
                        // Para nuevas imágenes, el backend asignará el ID después de guardar
                        // Por ahora dejamos vacío, el backend deberá manejar esto
                        updateCoverImageId('');
                    }
                });
            }
        }

        // Si el componente de galería JavaScript está presente, integrar con él
        if (window.LaptopGallery) {
            // Cuando la galería establezca una portada, actualizar el campo
            window.LaptopGallery.onCoverChange = function (imageId) {
                updateCoverImageId(imageId);
            };
        }
    });
</script>

<!-- Script para gestión de seriales -->
<script>
    // ==========================================
    // GESTIÓN DE SERIALES EN FORMULARIO
    // ==========================================

    let serialsList = [];

    // Inicializar con seriales existentes (modo edición)
    {% if mode == 'edit' and laptop %}
    document.addEventListener('DOMContentLoaded', function () {
        // Cargar seriales existentes desde la API
        fetch('/api/serials/laptop/{{ laptop.id }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.serials) {
                    data.serials.forEach(serial => {
                        if (serial.status === 'available') {
                            addSerialToList(serial.serial_number, serial.id);
                        }
                    });
                    updateSerialsUI();
                }
            })
            .catch(error => console.error('Error cargando seriales:', error));
    });
    {% endif %}

    // Escuchar Enter en el input
    document.getElementById('serial-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addSerialFromInput();
        }
    });

    // Escuchar cambios en cantidad
    document.getElementById('quantity')?.addEventListener('change', updateQuantityInfo);

    function addSerialFromInput() {
        const input = document.getElementById('serial-input');
        const serialNumber = input.value.trim().toUpperCase();

        if (!serialNumber) {
            showNotification('Ingresa un número de serie', 'warning');
            return;
        }

        // Verificar duplicados
        if (serialsList.some(s => s.serial_number === serialNumber)) {
            showNotification('Este serial ya está en la lista', 'warning');
            input.value = '';
            input.focus();
            return;
        }

        addSerialToList(serialNumber);
        input.value = '';
        input.focus();
        updateSerialsUI();
    }

    function addSerialToList(serialNumber, existingId = null) {
        serialsList.push({
            serial_number: serialNumber,
            id: existingId,
            isNew: !existingId
        });
    }

    function removeSerial(index) {
        serialsList.splice(index, 1);
        updateSerialsUI();
    }

    function updateSerialsUI() {
        const listContainer = document.getElementById('serials-list');
        const noSerialsMsg = document.getElementById('no-serials-message');
        const countBadge = document.getElementById('serial-count');
        const jsonInput = document.getElementById('serials-json');

        // Actualizar contador
        countBadge.textContent = serialsList.length + ' serial' + (serialsList.length !== 1 ? 'es' : '');

        // Actualizar JSON oculto
        jsonInput.value = JSON.stringify(serialsList.map(s => ({
            serial_number: s.serial_number,
            id: s.id
        })));

        // Mostrar/ocultar mensaje
        if (serialsList.length === 0) {
            noSerialsMsg.classList.remove('hidden');
            listContainer.innerHTML = '';
            return;
        }

        noSerialsMsg.classList.add('hidden');

        // Renderizar lista
        listContainer.innerHTML = serialsList.map((serial, index) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 ${serial.isNew ? 'border-l-4 border-l-green-500' : ''}">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h2m10 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                </svg>
                <span class="font-mono text-sm font-semibold text-gray-900 dark:text-white">${serial.serial_number}</span>
                ${serial.isNew ? '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 rounded">Nuevo</span>' : ''}
            </div>
            <button type="button" onclick="removeSerial(${index})" class="p-1 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 rounded">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `).join('');

        updateQuantityInfo();
    }

    function updateQuantityInfo() {
        const qtyInput = document.getElementById('quantity');
        const infoContainer = document.getElementById('serial-quantity-info');
        const inventoryQty = document.getElementById('inventory-qty');
        const serialsQty = document.getElementById('serials-qty');

        if (qtyInput && infoContainer) {
            const qty = parseInt(qtyInput.value) || 0;
            inventoryQty.textContent = qty;
            serialsQty.textContent = serialsList.length;

            if (qty > 0 || serialsList.length > 0) {
                infoContainer.classList.remove('hidden');

                // Advertencia si no coinciden
                if (serialsList.length > 0 && serialsList.length !== qty) {
                    serialsQty.classList.add('text-yellow-600');
                    serialsQty.classList.remove('text-purple-600');
                } else {
                    serialsQty.classList.remove('text-yellow-600');
                    serialsQty.classList.add('text-purple-600');
                }
            } else {
                infoContainer.classList.add('hidden');
            }
        }
    }

    function showNotification(message, type = 'info') {
        if (window.LaptopGalleryHybrid && window.LaptopGalleryHybrid.showNotification) {
            window.LaptopGalleryHybrid.showNotification(message, type);
        } else {
            alert(message);
        }
    }
</script>

<!-- html5-qrcode Library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<!-- Icecat Scanner Logic -->
<script src="{{ url_for('static', filename='js/icecat_scanner.js') }}"></script>
{% endblock %}