<!-- Formulario de cliente estilo Zoho - Versión Compacta -->
<form method="POST" id="customer-form" class="space-y-4">
    {{ form.hidden_tag() }}

    <!-- Sección 1: Identificación (2 columnas compactas) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
            </svg>
            Identificación
        </h3>

        <div class="grid grid-cols-1 gap-3">
            <!-- Número de Identificación CON BOTÓN DGII -->
            <div>
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.id_number.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.id_number(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10", placeholder="Ej: 001-1234567-8", maxlength="13") }}
                    </div>

                    <!-- BOTÓN DGII - AHORA VISIBLE -->
                    <div class="mb-1">
                        <button type="button" id="dgii-search-btn"
                                class="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <span>Consultar DGII</span>
                        </button>
                    </div>
                </div>

                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    9 dígitos (RNC) o 11 dígitos (Cédula) - <span class="text-blue-600 font-medium">Haz clic en "Consultar DGII" para buscar automáticamente</span>
                </p>

                <div id="id-error-message" class="error-message hidden text-xs mt-1"></div>

                <!-- Spinner para consulta DGII -->
                <div id="dgii-loading" class="hidden mt-2">
                    <div class="flex items-center text-blue-600 text-xs">
                        <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Consultando DGII, por favor espere...
                    </div>
                </div>

                <!-- Mensaje de resultado DGII -->
                <div id="dgii-result" class="hidden mt-2 text-xs"></div>
            </div>

            <!-- Tipo de Identificación y Tipo de cliente en la misma línea -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.id_type.label.text }}
                    </label>
                    {{ form.id_type(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 readonly-field", readonly=True, tabindex="-1") }}
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.customer_type.label.text }}
                    </label>
                    {{ form.customer_type(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 readonly-field", readonly=True, tabindex="-1") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Resto del formulario se mantiene igual... -->
    <!-- Sección 2: Información Personal/Empresa (combinada) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Campos de Persona -->
            <div id="person-fields" class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.first_name.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.first_name(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>

            <div id="person-fields-2" class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.last_name.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.last_name(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>

            <!-- Campos de Empresa -->
            <div id="company-fields" class="hidden-field md:col-span-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.company_name.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.company_name(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección 3: Contacto y Dirección (combinada en 2 columnas) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Contacto -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Contacto
            </h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.email.label.text }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.email(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    <div id="email-error-message" class="error-message hidden text-xs mt-1"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.phone_primary.label.text }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.phone_primary(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                        <div id="phone-error-message" class="error-message hidden text-xs mt-1"></div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.whatsapp.label.text }}
                        </label>
                        {{ form.whatsapp(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.phone_secondary.label.text }}
                    </label>
                    {{ form.phone_secondary(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>
        </div>

        <!-- Dirección -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Dirección
            </h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.address_line1.label.text }}
                    </label>
                    {{ form.address_line1(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.address_line2.label.text }}
                    </label>
                    {{ form.address_line2(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.city.label.text }}
                        </label>
                        {{ form.city(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                            {{ form.province.label.text }}
                        </label>
                        {{ form.province(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.postal_code.label.text }}
                    </label>
                    {{ form.postal_code(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección 4: Información Adicional Compacta (Colapsable) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <!-- Cabecera colapsable -->
        <button type="button"
                id="additional-info-toggle"
                class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                </svg>
                <span class="text-lg font-semibold text-gray-900 dark:text-white">Información Adicional</span>
            </div>
            <svg id="additional-info-chevron" class="w-5 h-5 text-gray-400 transform transition-transform duration-200 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>

        <!-- Contenido colapsable -->
        <div id="additional-info-content" class="px-4 pb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.credit_limit.label.text }}
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 text-sm">$</span>
                        {{ form.credit_limit(class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10") }}
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-200 mb-1">
                        {{ form.notes.label.text }}
                    </label>
                    {{ form.notes(class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10", rows="2") }}
                </div>

                <div class="flex items-center">
                    <label class="inline-flex items-center">
                        {{ form.is_active(class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded") }}
                        <span class="ml-2 text-xs font-semibold text-gray-700 dark:text-gray-300">{{ form.is_active.label.text }}</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones -->
    <div class="flex items-center justify-between pt-3">
        <a href="{{ url_for('customers.customers_list') }}" class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium">
            Cancelar
        </a>

        <button type="submit" class="px-6 py-2 text-sm bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium rounded shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200">
            {{ form.submit.label.text }}
        </button>
    </div>
</form>

<style>
    .hidden-field {
        display: none;
    }
    .readonly-field {
        background-color: #f9fafb !important;
        cursor: not-allowed;
        color: #6b7280;
    }
    .dark .readonly-field {
        background-color: #111827 !important;
        color: #9ca3af;
    }

    .error-message {
        color: #dc2626;
    }
    .dark .error-message {
        color: #f87171;
    }

    /* Para pantallas grandes, limitamos el ancho */
    @media (min-width: 1280px) {
        #customer-form {
            max-width: 900px;
            margin: 0 auto;
        }
    }

    /* Clases para el estado expandido/colapsado */
    .rotate-180 {
        transform: rotate(180deg);
    }

    /* Mensajes DGII */
    .dgii-success {
        color: #059669;
        background-color: #d1fae5;
        padding: 4px 8px;
        border-radius: 4px;
        border-left: 4px solid #059669;
    }
    .dark .dgii-success {
        color: #34d399;
        background-color: #064e3b;
    }

    .dgii-warning {
        color: #d97706;
        background-color: #fef3c7;
        padding: 4px 8px;
        border-radius: 4px;
        border-left: 4px solid #d97706;
    }
    .dark .dgii-warning {
        color: #fbbf24;
        background-color: #78350f;
    }

    .dgii-error {
        color: #dc2626;
        background-color: #fee2e2;
        padding: 4px 8px;
        border-radius: 4px;
        border-left: 4px solid #dc2626;
    }
    .dark .dgii-error {
        color: #f87171;
        background-color: #7f1d1d;
    }

    /* Clases para resaltar campos llenados automáticamente */
    .bg-green-50 {
        background-color: #f0fdf4;
    }
    .dark .bg-green-50 {
        background-color: rgb(20 83 45 / 0.2);
    }

    .bg-yellow-50 {
        background-color: #fefce8;
    }
    .dark .bg-yellow-50 {
        background-color: rgb(113 63 18 / 0.2);
    }

    .transition-bg {
        transition: background-color 0.5s ease;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerTypeSelect = document.getElementById('customer_type');
    const idTypeSelect = document.getElementById('id_type');
    const idNumberInput = document.getElementById('id_number');
    const dgiiSearchBtn = document.getElementById('dgii-search-btn');
    const dgiiLoading = document.getElementById('dgii-loading');
    const dgiiResult = document.getElementById('dgii-result');
    const personFields = document.getElementById('person-fields');
    const personFields2 = document.getElementById('person-fields-2');
    const companyFields = document.getElementById('company-fields');
    const emailInput = document.getElementById('email');
    const emailErrorMessage = document.getElementById('email-error-message');
    const phonePrimaryInput = document.getElementById('phone_primary');
    const phoneErrorMessage = document.getElementById('phone-error-message');
    const customerForm = document.getElementById('customer-form');
    const firstNameInput = document.getElementById('first_name');
    const lastNameInput = document.getElementById('last_name');
    const companyNameInput = document.getElementById('company_name');

    // Elementos para la sección colapsable
    const additionalInfoToggle = document.getElementById('additional-info-toggle');
    const additionalInfoContent = document.getElementById('additional-info-content');
    const additionalInfoChevron = document.getElementById('additional-info-chevron');

    // Debug: Verificar que los elementos existan
    console.log('Elementos cargados:', {
        idNumberInput: !!idNumberInput,
        dgiiSearchBtn: !!dgiiSearchBtn,
        dgiiLoading: !!dgiiLoading,
        dgiiResult: !!dgiiResult,
        customerTypeSelect: !!customerTypeSelect,
        idTypeSelect: !!idTypeSelect
    });

    // Función para formatear ID
    function formatIdNumber(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11) {
            return digits.replace(/(\d{3})(\d{7})(\d{1})/, '$1-$2-$3');
        } else if (digits.length === 9) {
            return digits.replace(/(\d{3})(\d{5})(\d{1})/, '$1-$2-$3');
        }
        return digits;
    }

    // Función para detectar tipo de ID
    function autoDetectIdType(value) {
        const digits = value.replace(/\D/g, '');
        if (digits.length === 11) {
            customerTypeSelect.value = 'person';
            idTypeSelect.value = 'cedula';
            return 'cedula';
        } else if (digits.length === 9) {
            customerTypeSelect.value = 'company';
            idTypeSelect.value = 'rnc';
            return 'rnc';
        } else if (digits.length > 0 && digits.length !== 11 && digits.length !== 9) {
            showIdError('Debe tener 9 (RNC) u 11 (Cédula) dígitos.');
            return null;
        } else {
            hideIdError();
            return null;
        }
    }

    function showIdError(message) {
        const errorDiv = document.getElementById('id-error-message');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        idNumberInput.classList.add('border-red-500');
        dgiiSearchBtn.classList.add('hidden');
    }

    function hideIdError() {
        const errorDiv = document.getElementById('id-error-message');
        errorDiv.classList.add('hidden');
        idNumberInput.classList.remove('border-red-500');
    }

    // Función para actualizar campos
    function updateFormFields() {
        const customerType = customerTypeSelect.value;

        if (customerType === 'person') {
            personFields.classList.remove('hidden-field');
            personFields2.classList.remove('hidden-field');
            companyFields.classList.add('hidden-field');
        } else if (customerType === 'company') {
            personFields.classList.add('hidden-field');
            personFields2.classList.add('hidden-field');
            companyFields.classList.remove('hidden-field');
        }
    }

    // Función para actualizar visibilidad del botón DGII - CORREGIDA
    function updateDgiiButton() {
        console.log('Actualizando visibilidad del botón DGII...');
        const digits = idNumberInput.value.replace(/\D/g, '');

        // Solo mostrar si tiene 9 u 11 dígitos y no está en proceso de consulta
        const isValidLength = (digits.length === 9 || digits.length === 11);
        const isNotLoading = dgiiLoading.classList.contains('hidden');
        const hasNoResult = dgiiResult.classList.contains('hidden');

        console.log('Estado:', { digits: digits.length, isValidLength, isNotLoading, hasNoResult });

        if (isValidLength && isNotLoading && hasNoResult) {
            console.log('Mostrando botón DGII');
            dgiiSearchBtn.classList.remove('hidden');
            dgiiSearchBtn.disabled = false;
        } else {
            console.log('Ocultando botón DGII');
            dgiiSearchBtn.classList.add('hidden');
            dgiiSearchBtn.disabled = true;
        }
    }

    // Función para consultar DGII - VERSIÓN MEJORADA
    async function consultarDGII() {
        console.log('Iniciando consulta DGII...');

        const idNumber = idNumberInput.value.replace(/\D/g, '');
        const idType = idTypeSelect.value;

        console.log('Consultando DGII:', { idNumber, idType });

        if (!idNumber || (idNumber.length !== 9 && idNumber.length !== 11)) {
            showIdError('Debe ingresar un número válido (9 o 11 dígitos)');
            return;
        }

        // Feedback visual inmediato
        const originalBtnHTML = dgiiSearchBtn.innerHTML;
        dgiiSearchBtn.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Consultando...
        `;
        dgiiSearchBtn.disabled = true;

        // Mostrar loading
        dgiiLoading.classList.remove('hidden');
        dgiiResult.classList.add('hidden');

        // Ocultar botón durante la consulta
        updateDgiiButton();

        try {
            const response = await fetch('/customers/check-dgii', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    id_number: idNumber,
                    id_type: idType
                })
            });

            const data = await response.json();
            console.log('Respuesta DGII:', data);

            // Restaurar el botón
            dgiiSearchBtn.innerHTML = originalBtnHTML;
            dgiiSearchBtn.disabled = false;

            dgiiLoading.classList.add('hidden');

            if (data.success) {
                // Mostrar mensaje de éxito
                dgiiResult.classList.remove('hidden');
                dgiiResult.innerHTML = `<div class="dgii-success">✓ ${data.message}</div>`;

                // Si tenemos datos de DGII, llenar los campos automáticamente
                if (data.data) {
                    const dgiiData = data.data;

                    if (idType === 'cedula') {
                        // Para cédula: llenar nombre y apellido
                        if (dgiiData.first_name) {
                            firstNameInput.value = dgiiData.first_name;
                            firstNameInput.classList.add('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                            setTimeout(() => {
                                firstNameInput.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                            }, 3000);
                        }

                        if (dgiiData.last_name) {
                            lastNameInput.value = dgiiData.last_name;
                            lastNameInput.classList.add('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                            setTimeout(() => {
                                lastNameInput.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                            }, 3000);
                        }

                        // Si no hay nombre/apellido pero hay full_name
                        if ((!firstNameInput.value || !lastNameInput.value) && dgiiData.full_name) {
                            const nameParts = dgiiData.full_name.split(' ');
                            if (nameParts.length > 1) {
                                firstNameInput.value = nameParts.slice(0, -1).join(' ');
                                lastNameInput.value = nameParts.slice(-1).join(' ');

                                firstNameInput.classList.add('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                                lastNameInput.classList.add('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                                setTimeout(() => {
                                    firstNameInput.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                                    lastNameInput.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                                }, 3000);
                            } else if (nameParts.length === 1) {
                                firstNameInput.value = nameParts[0];
                                firstNameInput.classList.add('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                                setTimeout(() => {
                                    firstNameInput.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                                }, 3000);
                            }
                        }
                    } else if (idType === 'rnc') {
                        // Para RNC: llenar nombre de empresa
                        if (dgiiData.company_name) {
                            companyNameInput.value = dgiiData.company_name;
                            companyNameInput.classList.add('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                            setTimeout(() => {
                                companyNameInput.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'transition-bg');
                            }, 3000);
                        }
                    }

                    // Mostrar mensaje adicional
                    if (dgiiData.status) {
                        dgiiResult.innerHTML += `<div class="mt-1 text-xs">Estado: ${dgiiData.status}</div>`;
                    }
                } else if (data.validation_mode === 'local') {
                    // Solo validación local exitosa
                    dgiiResult.classList.remove('hidden');
                    dgiiResult.innerHTML = `<div class="dgii-warning">ℹ️ ${data.message}</div>`;

                    // Resaltar campos para llenar manualmente
                    if (idType === 'cedula') {
                        firstNameInput.focus();
                        firstNameInput.classList.add('bg-yellow-50', 'dark:bg-yellow-900/20', 'transition-bg');
                        setTimeout(() => {
                            firstNameInput.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/20', 'transition-bg');
                        }, 3000);
                    } else if (idType === 'rnc') {
                        companyNameInput.focus();
                        companyNameInput.classList.add('bg-yellow-50', 'dark:bg-yellow-900/20', 'transition-bg');
                        setTimeout(() => {
                            companyNameInput.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/20', 'transition-bg');
                        }, 3000);
                    }
                }

                // Ocultar mensaje después de 8 segundos
                setTimeout(() => {
                    dgiiResult.classList.add('hidden');
                    updateDgiiButton();
                }, 8000);

            } else {
                // Mostrar error
                dgiiResult.classList.remove('hidden');
                dgiiResult.innerHTML = `<div class="dgii-error">✗ ${data.error || 'Error al consultar DGII'}</div>`;

                // Mostrar error por 5 segundos
                setTimeout(() => {
                    dgiiResult.classList.add('hidden');
                    updateDgiiButton();
                }, 5000);
            }

        } catch (error) {
            console.error('Error consultando DGII:', error);

            // Restaurar el botón en caso de error
            dgiiSearchBtn.innerHTML = originalBtnHTML;
            dgiiSearchBtn.disabled = false;

            dgiiLoading.classList.add('hidden');
            dgiiResult.classList.remove('hidden');
            dgiiResult.innerHTML = `<div class="dgii-error">✗ Error de conexión con DGII. Complete los datos manualmente.</div>`;

            setTimeout(() => {
                dgiiResult.classList.add('hidden');
                updateDgiiButton();
            }, 5000);
        }
    }

    // Funciones de validación
    function validateEmail() {
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) {
            emailErrorMessage.textContent = 'El correo electrónico es requerido.';
            emailErrorMessage.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
            return false;
        } else if (!emailRegex.test(email)) {
            emailErrorMessage.textContent = 'Por favor ingrese un correo electrónico válido.';
            emailErrorMessage.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
            return false;
        } else {
            emailErrorMessage.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
            return true;
        }
    }

    function validatePhone() {
        const phonePrimary = phonePrimaryInput.value.trim();
        if (!phonePrimary) {
            phoneErrorMessage.textContent = 'El teléfono principal es requerido.';
            phoneErrorMessage.classList.remove('hidden');
            phonePrimaryInput.classList.add('border-red-500');
            return false;
        } else {
            phoneErrorMessage.classList.add('hidden');
            phonePrimaryInput.classList.remove('border-red-500');
            return true;
        }
    }

    function validateForm() {
        const isEmailValid = validateEmail();
        const isPhoneValid = validatePhone();
        const idValue = idNumberInput.value.trim();
        const digits = idValue.replace(/\D/g, '');
        let isIdValid = true;

        if (digits.length === 0) {
            showIdError('El número de identificación es requerido.');
            isIdValid = false;
        } else if (digits.length !== 11 && digits.length !== 9) {
            showIdError('Debe tener 9 (RNC) u 11 (Cédula) dígitos.');
            isIdValid = false;
        } else {
            hideIdError();
        }

        return isEmailValid && isPhoneValid && isIdValid;
    }

    // Función para alternar la sección de información adicional
    function toggleAdditionalInfo(e) {
        e.preventDefault();
        e.stopPropagation();

        const isHidden = additionalInfoContent.classList.contains('hidden');

        if (isHidden) {
            // Expandir
            additionalInfoContent.classList.remove('hidden');
            additionalInfoChevron.classList.add('rotate-180');
        } else {
            // Colapsar
            additionalInfoContent.classList.add('hidden');
            additionalInfoChevron.classList.remove('rotate-180');
        }
    }

    // Event listeners
    idNumberInput.addEventListener('input', function(e) {
        const cursorPosition = e.target.selectionStart;
        const originalValue = e.target.value;
        const formattedValue = formatIdNumber(e.target.value);
        e.target.value = formattedValue;

        // Mantener posición del cursor
        const diff = formattedValue.length - originalValue.length;
        if (diff !== 0) {
            e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
        }

        autoDetectIdType(formattedValue);
        updateFormFields();
        updateDgiiButton();
    });

    idNumberInput.addEventListener('blur', function() {
        const digits = this.value.replace(/\D/g, '');
        if (digits.length === 11 || digits.length === 9) {
            this.value = formatIdNumber(this.value);
            autoDetectIdType(this.value);
            updateFormFields();
            updateDgiiButton();
        }
    });

    // Event listener para el botón de búsqueda DGII
    dgiiSearchBtn.addEventListener('click', function(e) {
        console.log('Botón DGII clickeado'); // Para debug
        e.preventDefault();
        consultarDGII();
    });

    emailInput.addEventListener('blur', validateEmail);
    phonePrimaryInput.addEventListener('blur', validatePhone);

    // Event listener para la sección colapsable
    additionalInfoToggle.addEventListener('click', toggleAdditionalInfo);

    customerForm.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            const firstError = document.querySelector('.error-message:not(.hidden)');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Inicialización
    console.log('Inicializando formulario...');
    if (idNumberInput.value) {
        const digits = idNumberInput.value.replace(/\D/g, '');
        idNumberInput.value = formatIdNumber(idNumberInput.value);
        autoDetectIdType(idNumberInput.value);
    }
    updateFormFields();
    updateDgiiButton(); // Llamar explícitamente al inicio
});
</script>